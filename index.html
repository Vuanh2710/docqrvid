<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Xử Lý Video QR & Barcode: Ghi, Lưu & Tải Lên</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsQR for QR Code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- JSZip for zipping files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Google Platform Library & Identity Services Client -->
    <script async defer src="https://apis.google.com/js/api.js" onload="onGapiLoad()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGisLoad()"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; /* Fallback background */
        }
        .tab-button.active {
            background-color: white;
            color: #4f46e5; /* theme('colors.indigo.600') */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            text-align: center;
        }
        .btn:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
            transform: translateY(-2px);
        }
        .btn:disabled {
            background-color: #9ca3af; /* theme('colors.gray.400') */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn-primary { background-color: #4f46e5; color: white; } /* indigo-600 */
        .btn-primary:hover { background-color: #4338ca; } /* indigo-700 */
        .btn-danger { background-color: #dc2626; color: white; } /* red-600 */
        .btn-danger:hover { background-color: #b91c1c; } /* red-700 */
        .btn-success { background-color: #16a34a; color: white; } /* green-600 */
        .btn-success:hover { background-color: #15803d; } /* green-700 */
        .btn-special { background-color: #8b5cf6; color: white; } /* purple-600 */
        .btn-special:hover { background-color: #7c3aed; } /* purple-700 */
        
        .detection-popup {
            animation: fadeInOut 2s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: scale(0.7); }
            20%, 80% { opacity: 1; transform: scale(1); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        .segment-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-blue-100 min-h-screen p-4 md:p-8 flex items-center justify-center">
    <div class="container mx-auto max-w-4xl bg-white/80 backdrop-blur-sm p-5 md:p-8 rounded-2xl shadow-2xl border border-gray-200/50">
        <header class="mb-6 md:mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 tracking-tight">Trình Xử Lý Video & Mã Code</h1>
        </header>

        <!-- Google Authentication Section -->
        <section class="mb-8 p-4 bg-white/60 rounded-xl shadow-md">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">Kết nối Google</h2>
            <div id="googleAuthControls" class="flex items-center space-x-4">
                <button id="googleSignInButton" class="btn bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 text-sm">
                    Đăng nhập với Google
                </button>
                <button id="googleSignOutButton" class="btn bg-red-500 hover:bg-red-600 text-white py-2 px-4 text-sm hidden">
                    Đăng xuất Google
                </button>
                 <div id="googleAuthMessageArea" class="text-sm text-gray-700"></div>
            </div>
        </section>

        <!-- Tabs Navigation -->
        <div class="mb-6">
            <nav class="p-1.5 flex space-x-2 bg-gray-200/70 rounded-xl" aria-label="Tabs">
                <button data-tab="fileTab" class="tab-button active flex-1 py-2 px-4 rounded-lg font-medium text-sm transition-all duration-300">
                    Quét Video Từ File
                </button>
                <button data-tab="cameraTab" class="tab-button flex-1 text-gray-600 py-2 px-4 rounded-lg font-medium text-sm transition-all duration-300">
                    Ghi & Quét Từ Camera
                </button>
            </nav>
        </div>

        <div>
            <!-- File Scanning Tab -->
            <div id="fileTabContent" class="tab-content">
                <section class="mb-6">
                    <label for="videoFile" class="block text-sm font-medium text-gray-700 mb-2">Chọn file video của bạn:</label>
                    <input type="file" id="videoFile" accept="video/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </section>

                <section class="mb-6 relative">
                    <video id="videoPlayer" controls playsinline class="w-full rounded-lg shadow-md aspect-video bg-black"></video>
                    <canvas id="scannerCanvas" class="hidden"></canvas>
                    <div id="fileDetectionOverlay" class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none hidden bg-black bg-opacity-30 rounded-lg">
                        <span class="text-red-500 font-bold text-4xl md:text-5xl text-center break-all" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);"></span>
                    </div>
                </section>

                <section class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button id="scanButton" disabled class="btn btn-primary col-span-2 md:col-span-1">Bắt đầu quét</button>
                    <button id="exportCsvButton" disabled class="btn btn-success">Xuất CSV</button>
                    <button id="downloadAllFileSegmentsButton" disabled class="btn btn-special">Tải tất cả</button>
                    <button id="uploadSheetFileButton" disabled class="btn btn-success">Tải lên Sheets</button>
                </section>

                <div class="mb-4 min-h-[40px]">
                    <div id="messageArea" class="message-box">
                         <p class="text-gray-500 text-center">Vui lòng chọn một video để bắt đầu.</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <section class="bg-white/50 p-4 rounded-lg shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 border-b-2 border-gray-200 pb-2">Mã đã phát hiện (File):</h2>
                        <div id="codeLog" class="space-y-2 max-h-60 overflow-y-auto text-sm pr-2">
                            <p class="text-gray-500 italic">Chưa có mã nào được phát hiện.</p>
                        </div>
                    </section>
                    <section class="bg-white/50 p-4 rounded-lg shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 border-b-2 border-gray-200 pb-2">Các đoạn video (File):</h2>
                        <div id="segments" class="space-y-2 max-h-60 overflow-y-auto text-sm pr-2">
                             <p class="text-gray-500 italic">Chưa có đoạn video nào được tạo.</p>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Camera Recording Tab -->
            <div id="cameraTabContent" class="tab-content hidden">
                <section class="mb-6 relative">
                    <video id="cameraPlayer" autoplay playsinline muted class="w-full rounded-lg shadow-md aspect-video bg-black"></video>
                    <canvas id="cameraScannerCanvas" class="hidden"></canvas>
                     <div id="cameraDetectionOverlay" class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none hidden bg-black bg-opacity-30 rounded-lg">
                        <span class="text-red-500 font-bold text-4xl md:text-5xl text-center break-all" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);"></span>
                    </div>
                </section>

                <section class="mb-6 space-y-3">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button id="startCameraButton" class="btn btn-primary">Bắt đầu Ghi</button>
                        <button id="stopCameraButton" disabled class="btn btn-danger">Dừng Ghi</button>
                        <button id="exportCameraCsvButton" disabled class="btn btn-success">Xuất CSV</button>
                        <button id="downloadAllCameraSegmentsButton" disabled class="btn btn-special">Tải tất cả</button>
                    </div>
                     <div class="grid grid-cols-1">
                        <button id="uploadSheetCameraButton" disabled class="btn btn-success">Tải lên Google Sheets</button>
                    </div>
                    <!-- NEW: Auto-action checkboxes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-gray-100 rounded-lg">
                        <div class="flex items-center">
                            <input type="checkbox" id="autoDownloadCheckbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="autoDownloadCheckbox" class="ml-2 block text-sm text-gray-700">Tự động tải về máy</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="autoUploadCheckbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" disabled>
                            <label for="autoUploadCheckbox" class="ml-2 block text-sm text-gray-700">Tự động tải lên Google Drive</label>
                        </div>
                    </div>
                </section>

                <div class="mb-4 min-h-[40px]">
                    <div id="cameraMessageArea" class="message-box">
                         <p class="text-gray-500 text-center">Nhấn "Bắt đầu Ghi & Quét Mã" để sử dụng camera.</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <section class="bg-white/50 p-4 rounded-lg shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 border-b-2 border-gray-200 pb-2">Mã đã phát hiện (Camera):</h2>
                        <div id="cameraCodeLog" class="space-y-2 max-h-60 overflow-y-auto text-sm pr-2">
                            <p class="text-gray-500 italic">Chưa có mã nào được phát hiện.</p>
                        </div>
                    </section>
                    <section class="bg-white/50 p-4 rounded-lg shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 border-b-2 border-gray-200 pb-2">Các đoạn video đã ghi (Camera):</h2>
                        <div id="cameraSegments" class="space-y-2 max-h-60 overflow-y-auto text-sm pr-2">
                             <p class="text-gray-500 italic">Chưa có đoạn video nào được ghi.</p>
                        </div>
                    </section>
                </div>
            </div>
        </div>

         <footer class="mt-8 text-center text-xs text-gray-400">
            <p>Ứng dụng sử dụng thư viện jsQR và Barcode Detector API của trình duyệt. Chức năng Google yêu cầu đăng nhập.</p>
        </footer>
    </div>

    <script>
    // --- Google Auth Initialization ---
    let gapiReady = false;
    let gisReady = false;
    
    function onGapiLoad() {
        gapi.load('client', () => {
            gapiReady = true;
            if (window.tryInitializeApp) window.tryInitializeApp();
        });
    }

    function onGisLoad() {
        gisReady = true;
        if (window.tryInitializeApp) window.tryInitializeApp();
    }
    
    // --- App Logic ---
    (function() {
        if (typeof window.APP_INITIALIZED !== 'undefined') {
            return;
        }
        window.APP_INITIALIZED = true;

        const API_KEY = 'AIzaSyD7pU2xCHySsNnfgvIyCw8h25kwwU7dKo4';
        const CLIENT_ID = '31711163070-g0hhnvlhlvh91jij0k50k58o6usijj17.apps.googleusercontent.com';
        const DISCOVERY_DOCS = [
            "https://sheets.googleapis.com/$discovery/rest?version=v4",
            "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"
        ];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        
        let appStarted = false;
        window.tryInitializeApp = function() {
            if (gapiReady && gisReady && !appStarted) {
                appStarted = true;
                main();
            }
        };

        function main() {
            // --- DOM Element Variables ---
            const googleSignInButton = document.getElementById('googleSignInButton');
            const googleSignOutButton = document.getElementById('googleSignOutButton');
            const googleAuthMessageArea = document.getElementById('googleAuthMessageArea');
            const uploadSheetFileButton = document.getElementById('uploadSheetFileButton');
            const uploadSheetCameraButton = document.getElementById('uploadSheetCameraButton');
            const videoFile = document.getElementById('videoFile');
            const videoPlayer = document.getElementById('videoPlayer');
            const scannerCanvas = document.getElementById('scannerCanvas');
            const scanButton = document.getElementById('scanButton');
            const exportCsvButton = document.getElementById('exportCsvButton');
            const downloadAllFileSegmentsButton = document.getElementById('downloadAllFileSegmentsButton');
            const codeLog = document.getElementById('codeLog');
            const segmentsDiv = document.getElementById('segments');
            const messageArea = document.getElementById('messageArea');
            const cameraPlayerEl = document.getElementById('cameraPlayer');
            const cameraScannerCanvasEl = document.getElementById('cameraScannerCanvas');
            const startCameraButton = document.getElementById('startCameraButton');
            const stopCameraButton = document.getElementById('stopCameraButton');
            const exportCameraCsvButton = document.getElementById('exportCameraCsvButton');
            const downloadAllCameraSegmentsButtonCamera = document.getElementById('downloadAllCameraSegmentsButton');
            const cameraCodeLogEl = document.getElementById('cameraCodeLog');
            const cameraSegmentsEl = document.getElementById('cameraSegments');
            const cameraMessageAreaEl = document.getElementById('cameraMessageArea');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            // NEW: Auto-action checkboxes
            const autoUploadCheckbox = document.getElementById('autoUploadCheckbox');
            const autoDownloadCheckbox = document.getElementById('autoDownloadCheckbox');

            // --- State Variables ---
            let barcodeDetector;
            let fileScanTimeoutId = null;
            let notificationTimeout;
            let detectedFileCodes = [];
            let isFileScanning = false;
            let fileScannerCtx;
            let currentFileVideoDuration = 0;
            let fileVideoLoaded = false;
            let cameraStream;
            let detectedCameraCodes = [];
            let isCameraRecording = false;
            let currentCameraSegmentRecorder;
            let currentCameraSegmentChunks = [];
            let currentCameraCodeData = null;
            let currentCameraSegmentStartTimeMs = 0;
            let cameraScanIntervalId = null;
            let cameraScannerCtx;
            
            initializeLibraries();
            setupEventListeners();
        
            async function initializeLibraries() {
                if (typeof jsQR === 'undefined') {
                    updateMessage("Lỗi: Thư viện quét QR code (jsQR) không thể tải.", "error", messageArea);
                    updateMessage("Lỗi: Thư viện quét QR code (jsQR) không thể tải.", "error", cameraMessageAreaEl);
                    return;
                }

                if ('BarcodeDetector' in window) {
                    try {
                        const supportedFormats = await window.BarcodeDetector.getSupportedFormats();
                        if (supportedFormats.length > 0) {
                            barcodeDetector = new window.BarcodeDetector({ formats: supportedFormats });
                        } else { throw new Error("No supported formats found"); }
                    } catch (e) {
                        barcodeDetector = null;
                        updateMessage("Không thể khởi tạo tính năng quét Barcode. Chỉ quét được QR.", "warning", messageArea);
                        updateMessage("Không thể khởi tạo tính năng quét Barcode. Chỉ quét được QR.", "warning", cameraMessageAreaEl);
                    }
                } else {
                    updateMessage("Trình duyệt này không hỗ trợ quét Barcode. Chỉ có thể quét mã QR.", "warning", messageArea);
                    updateMessage("Trình duyệt này không hỗ trợ quét Barcode. Chỉ có thể quét mã QR.", "warning", cameraMessageAreaEl);
                }

                fileScannerCtx = scannerCanvas.getContext('2d', { willReadFrequently: true });
                initializeGapiClient();
            }

            function setupEventListeners() {
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        switchTab(button.getAttribute('data-tab'));
                    });
                });

                googleSignInButton.addEventListener('click', handleSignIn);
                googleSignOutButton.addEventListener('click', handleSignOut);
                uploadSheetFileButton.addEventListener('click', () => createAndUploadToSheet(detectedFileCodes, "File", messageArea));
                uploadSheetCameraButton.addEventListener('click', () => createAndUploadToSheet(detectedCameraCodes, "Camera", cameraMessageAreaEl));
                
                videoFile.addEventListener('change', handleFileSelect);
                scanButton.addEventListener('click', toggleFileScan);
                exportCsvButton.addEventListener('click', () => exportToCSV(detectedFileCodes, "danh_sach_code_file.csv", messageArea));
                downloadAllFileSegmentsButton.addEventListener('click', () => downloadAllSegments(detectedFileCodes.filter(c => c.blob), 'FILE', messageArea));
                videoPlayer.addEventListener('loadedmetadata', handleFileMetadataLoaded);
                videoPlayer.addEventListener('error', () => handleVideoError(videoPlayer.error, messageArea, scanButton, exportCsvButton));

                startCameraButton.addEventListener('click', startCameraScanAndRecord);
                stopCameraButton.addEventListener('click', stopCameraScanAndRecord);
                exportCameraCsvButton.addEventListener('click', () => exportToCSV(detectedCameraCodes, "danh_sach_code_camera.csv", cameraMessageAreaEl));
                downloadAllCameraSegmentsButtonCamera.addEventListener('click', () => downloadAllSegments(detectedCameraCodes.filter(c => c.blob), 'CAM', cameraMessageAreaEl));
            }
            
            function switchTab(targetTab) {
                 tabButtons.forEach(btn => btn.classList.remove('active'));
                 const activeButton = document.querySelector(`[data-tab="${targetTab}"]`);
                 if (activeButton) {
                    activeButton.classList.add('active');
                 }
                 tabContents.forEach(content => {
                    if (content.id === targetTab + 'Content') {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                 });
                 if (targetTab !== 'cameraTab' && isCameraRecording) {
                     stopCameraScanAndRecord();
                 }
            }
            
            // --- Google Auth & API Functions ---
            async function initializeGapiClient() {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: DISCOVERY_DOCS,
                    });
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: gapiTokenCallback,
                    });
                } catch (e) {
                    console.error("Error initializing Google API Client:", e);
                    let userMessage = "Lỗi khởi tạo Google API.";
                    if (e.result && e.result.error) {
                        const error = e.result.error;
                        userMessage = `Lỗi Google API: API Key không hợp lệ.`;
                        if (error.details && error.details[0] && error.details[0].reason === 'API_KEY_INVALID') {
                             userMessage += " Vui lòng kiểm tra lại API Key và cấu hình trong Google Cloud Console.";
                        }
                    } else if (e.message) {
                         userMessage = `Lỗi: ${e.message}`;
                    }
                    if(googleAuthMessageArea) googleAuthMessageArea.textContent = userMessage;
                }
            }
            
            function gapiTokenCallback(tokenResponse) {
                if (tokenResponse && tokenResponse.access_token) {
                    gapi.client.setToken(tokenResponse);
                    updateSigninStatus(true);
                } else {
                    updateSigninStatus(false);
                    googleAuthMessageArea.textContent = 'Đăng nhập Google thất bại.';
                }
            }
            
            function handleSignIn() {
                if (tokenClient) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    googleAuthMessageArea.textContent = 'Google Client chưa sẵn sàng, vui lòng thử lại sau giây lát.';
                }
            }

            function handleSignOut() {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken('');
                        updateSigninStatus(false);
                    });
                }
            }

            function updateSigninStatus(isSignedIn) {
                if (isSignedIn) {
                    googleSignInButton.classList.add('hidden');
                    googleSignOutButton.classList.remove('hidden');
                    googleAuthMessageArea.textContent = 'Đã đăng nhập thành công!';
                    autoUploadCheckbox.disabled = false;
                } else {
                    googleSignInButton.classList.remove('hidden');
                    googleSignOutButton.classList.add('hidden');
                    googleAuthMessageArea.textContent = '';
                    autoUploadCheckbox.disabled = true;
                    autoUploadCheckbox.checked = false;
                }
                updateAllButtonStates();
            }

            function updateAllButtonStates() {
                const isSignedIn = !!(gapi.client && gapi.client.getToken());
                
                uploadSheetFileButton.disabled = detectedFileCodes.length === 0 || !isSignedIn;
                document.querySelectorAll('#segments .upload-drive-button').forEach(btn => {
                    btn.disabled = !isSignedIn || btn.textContent.includes("Đã tải lên") || btn.textContent.includes("Đang tải");
                });
                
                uploadSheetCameraButton.disabled = detectedCameraCodes.length === 0 || !isSignedIn;
                document.querySelectorAll('#cameraSegments .upload-drive-button').forEach(btn => {
                    btn.disabled = !isSignedIn || btn.textContent.includes("Đã tải lên") || btn.textContent.includes("Đang tải");
                });
            }
            
            async function createAndUploadToSheet(dataArray, titleSuffix, msgAreaElement) {
                // ... (no changes in this function)
            }

            async function uploadVideoToDrive(codeInfo, fileName, msgAreaElement, buttonElement) {
                if (!gapi.client.getToken()) {
                    updateMessage("Bạn chưa đăng nhập Google để tải lên.", "error", msgAreaElement); return;
                }
                 if (!codeInfo || !codeInfo.blob) {
                    console.warn("Upload attempt failed: no blob data for", codeInfo);
                    if (buttonElement) { // Handle manual click case
                       buttonElement.innerHTML = 'Lỗi: Không có dữ liệu';
                       buttonElement.disabled = true;
                    }
                    return;
                }
                
                if (buttonElement) { // Manual upload has a button
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = 'Đang tải... <span class="loader"></span>';
                }

                const metadata = { name: fileName, mimeType: codeInfo.blob.type || 'video/webm' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', codeInfo.blob);

                try {
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token },
                        body: form
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error?.message || 'Lỗi không xác định');
                    
                    updateMessage(`File "${fileName}" đã tải lên Google Drive!`, "success", msgAreaElement);
                    if (buttonElement) {
                        buttonElement.innerHTML = 'Đã tải lên';
                        buttonElement.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                        buttonElement.classList.add('bg-gray-400');
                    }
                    codeInfo.isUploaded = true;

                } catch (err) {
                    updateMessage(`Lỗi tải lên Google Drive: ${err.message}`, "error", msgAreaElement);
                    if (buttonElement) {
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = 'Thử lại';
                    }
                    codeInfo.isUploaded = false; // Mark as failed
                } finally {
                    checkAndReleaseMemory(codeInfo);
                }
            }

            // --- File Tab Logic --- (no changes)
            function handleFileSelect(event) { /* ... */ }
            function handleFileMetadataLoaded() { /* ... */ }
            function resetFileScannerState() { /* ... */ }
            function toggleFileScan() { /* ... */ }
            function stopFileScan() { /* ... */ }
            async function startFullFileScan() { /* ... */ }
            async function processVideoFrame(currentTimeToScan) { /* ... */ }
            function finishFileScan() { /* ... */ }
            async function generateVideoFileSegments() { /* ... */ }
            function recordSegmentToFile(startTime, endTime) { /* ... */ }
            
            // --- Camera Tab Logic ---
            async function startCameraScanAndRecord() {
                if (isCameraRecording) return;
                resetCameraStateBeforeStart();
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: true });
                    cameraPlayerEl.srcObject = cameraStream;
                    await cameraPlayerEl.play();
                    
                    cameraScannerCanvasEl.width = cameraPlayerEl.videoWidth;
                    cameraScannerCanvasEl.height = cameraPlayerEl.videoHeight;
                    cameraScannerCtx = cameraScannerCanvasEl.getContext('2d', { willReadFrequently: true });
                    
                    isCameraRecording = true;
                    startCameraButton.disabled = true; 
                    stopCameraButton.disabled = false;
                    autoDownloadCheckbox.disabled = true;
                    autoUploadCheckbox.disabled = true;
                    updateMessage("Camera đang bật. Đang chờ mã đầu tiên...", "info", cameraMessageAreaEl, true);
                    
                    cameraScanIntervalId = setInterval(scanFrameFromCamera, 500); // Scan every 0.5s
                } catch (err) {
                    updateMessage(`Lỗi camera: ${err.message}.`, "error", cameraMessageAreaEl);
                }
            }
            
            async function scanFrameFromCamera() {
                if (!isCameraRecording) return;
                cameraScannerCtx.drawImage(cameraPlayerEl, 0, 0, cameraScannerCanvasEl.width, cameraScannerCanvasEl.height);
                const detectedCode = await scanCanvasForCode(cameraScannerCanvasEl, cameraScannerCtx);

                if (detectedCode) {
                    const codeData = detectedCode.data;
                    const codeType = detectedCode.type;

                    if (!currentCameraCodeData) { // First code detected
                        startNewRecordingForNewCode(codeData, codeType);
                    } else if (codeData !== currentCameraCodeData) { // New, different code detected
                        const endingCodeInfo = detectedCameraCodes.find(c => c.startTimeMs === currentCameraSegmentStartTimeMs);
                        await stopCurrentRecordingAndFinalizeSegment(endingCodeInfo);
                        startNewRecordingForNewCode(codeData, codeType);
                    }
                }
            }
            
            function startNewRecordingForNewCode(codeData, codeType) {
                currentCameraCodeData = codeData;
                currentCameraSegmentStartTimeMs = Date.now();
                
                const newCodeInfo = { 
                    data: codeData, 
                    type: codeType, 
                    startTimeMs: currentCameraSegmentStartTimeMs,
                    id: 'code-cam-' + currentCameraSegmentStartTimeMs,
                    blob: null,
                    blobUrl: null, // NEW: To store object URL for cleanup
                    // NEW: Status tracking for memory management
                    downloadRequired: autoDownloadCheckbox.checked,
                    uploadRequired: autoUploadCheckbox.checked && gapi.client.getToken(),
                    isDownloaded: false,
                    isUploaded: false,
                };

                detectedCameraCodes.push(newCodeInfo);
                displayCodeEntry(null, codeData, codeType, cameraCodeLogEl, currentCameraSegmentStartTimeMs);
                updateMessage(`Phát hiện mã: ${codeData}. Bắt đầu ghi...`, "success", cameraMessageAreaEl, true);
                showDetectionNotification(codeData, 'cameraDetectionOverlay');
                startNewCameraSegmentRecording();
            }

            function startNewCameraSegmentRecording() {
                if (!cameraStream) return;
                
                const mimeType = getSupportedMimeType();
                 if (!mimeType) {
                    updateMessage("Không tìm thấy định dạng video được hỗ trợ để ghi.", 'error', cameraMessageAreaEl);
                    return;
                }

                currentCameraSegmentChunks = [];
                currentCameraSegmentRecorder = new MediaRecorder(cameraStream, { mimeType });
                currentCameraSegmentRecorder.ondataavailable = e => { if (e.data.size > 0) currentCameraSegmentChunks.push(e.data); };
                currentCameraSegmentRecorder.onerror = e => {
                     console.error("MediaRecorder error:", e);
                     updateMessage("Lỗi khi ghi video.", 'error', cameraMessageAreaEl);
                };
                currentCameraSegmentRecorder.start();
            }
            
            function stopCurrentRecordingAndFinalizeSegment(codeInfoToFinalize) {
                return new Promise((resolve) => {
                    if (currentCameraSegmentRecorder?.state === "recording") {
                        currentCameraSegmentRecorder.onstop = () => {
                            const blob = new Blob(currentCameraSegmentChunks, { type: currentCameraSegmentRecorder.mimeType });
                            
                            if (codeInfoToFinalize && blob.size > 0) {
                               codeInfoToFinalize.blob = blob;
                               handleNewSegmentCompletion(codeInfoToFinalize);
                            }
                            
                            currentCameraSegmentChunks = [];
                            resolve();
                        };
                        currentCameraSegmentRecorder.stop();
                    } else {
                        resolve();
                    }
                });
            }

            function stopCameraScanAndRecord() {
                if (!isCameraRecording) return;
                isCameraRecording = false;
                clearInterval(cameraScanIntervalId);
                
                const finalCodeInfo = detectedCameraCodes.find(c => c.startTimeMs === currentCameraSegmentStartTimeMs);

                stopCurrentRecordingAndFinalizeSegment(finalCodeInfo).then(() => {
                    if (cameraStream) {
                        cameraStream.getTracks().forEach(track => track.stop());
                        cameraStream = null;
                    }
                    cameraPlayerEl.srcObject = null;
                    currentCameraCodeData = null;
                    startCameraButton.disabled = false;
                    stopCameraButton.disabled = true;
                    autoDownloadCheckbox.disabled = false;
                    if (gapi.client.getToken()) autoUploadCheckbox.disabled = false;
                    
                    if (detectedCameraCodes.length > 0) {
                        exportCameraCsvButton.disabled = false;
                        downloadAllCameraSegmentsButton.disabled = false;
                        if(gapi.client.getToken()) uploadSheetCameraButton.disabled = false;
                        updateMessage("Đã dừng ghi. Các đoạn video đã được lưu.", "success", cameraMessageAreaEl);
                    } else {
                         updateMessage("Đã dừng camera.", "info", cameraMessageAreaEl);
                    }
                });
            }

            function resetCameraStateBeforeStart() {
                if (isCameraRecording) stopCameraScanAndRecord();
                // Clean up any remaining blobs and URLs before starting a new session
                detectedCameraCodes.forEach(code => {
                    if (code.blobUrl) URL.revokeObjectURL(code.blobUrl);
                });
                detectedCameraCodes = [];
                cameraCodeLogEl.innerHTML = '<p class="text-gray-500 italic">Chưa có mã nào được phát hiện.</p>';
                cameraSegmentsEl.innerHTML = '<p class="text-gray-500 italic">Chưa có đoạn video nào được ghi.</p>';
                exportCameraCsvButton.disabled = true; 
                downloadAllCameraSegmentsButton.disabled = true;
                uploadSheetCameraButton.disabled = true;
                currentCameraCodeData = null;
            }

            // --- Scanning & UI Helper Functions ---
            async function scanCanvasForCode(canvas, context) { /* ... (no changes) */ }
            function showDetectionNotification(codeData, overlayId) { /* ... (no changes) */ }
            function displayCodeEntry(time, data, type, logElement, timestampMs = null) { /* ... (no changes) */ }
            function createFileSegmentUI(index, codeInfo, startTime, endTime, blob) { /* ... (no changes) */ }

            function createCameraSegmentUI(codeInfo) {
                const cameraSegmentsEl = document.getElementById('cameraSegments');
                cameraSegmentsEl.querySelector('p.italic')?.remove();
                const segmentWrapper = document.createElement('div');
                // NEW: Add ID to wrapper for later reference
                segmentWrapper.id = codeInfo.id; 
                segmentWrapper.className = 'p-3 mb-2 bg-blue-50 rounded-md shadow-sm transition-all duration-500';
                
                const extension = getMimeTypeExtension(codeInfo.blob.type);
                const fileName = `CAM_CODE_${sanitizeFileName(codeInfo.data)}_${new Date(codeInfo.startTimeMs).toLocaleTimeString().replace(/:/g,'-')}.${extension}`;
                
                // NEW: Store blobUrl in codeInfo for memory management
                codeInfo.blobUrl = URL.createObjectURL(codeInfo.blob);
                
                segmentWrapper.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-blue-700">${escapeHTML(codeInfo.type)}</p>
                            <p class="text-sm break-all">${escapeHTML(codeInfo.data)}</p>
                            <p class="text-xs text-gray-700">Thời gian: ${new Date(codeInfo.startTimeMs).toLocaleTimeString()}</p>
                        </div>
                        <!-- NEW: Status Indicator -->
                        <div class="status-indicator-container text-right">
                           <span class="segment-status bg-yellow-200 text-yellow-800">Đang chờ</span>
                        </div>
                    </div>
                    <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <button class="play-btn action-button bg-sky-500 hover:bg-sky-600 text-white text-sm py-1">Phát</button>
                        <button class="download-btn action-button bg-teal-500 hover:bg-teal-600 text-white text-sm py-1">Tải xuống</button>
                        <button class="upload-drive-button action-button google-button bg-purple-500 hover:bg-purple-600 text-white text-sm py-1" ${!(gapi.client && gapi.client.getToken()) && 'disabled'}>Tải lên Drive</button>
                    </div>
                    <div class="video-container mt-2"></div>
                `;
                
                const uploadButton = segmentWrapper.querySelector('.upload-drive-button');
                segmentWrapper.querySelector('.play-btn').onclick = () => {
                    const container = segmentWrapper.querySelector('.video-container');
                    if (codeInfo.blobUrl) { // Check if memory is already released
                        container.innerHTML = `<video src="${codeInfo.blobUrl}" controls autoplay class="w-full rounded-md mt-2"></video>`;
                    } else {
                        container.innerHTML = `<p class="text-center text-sm text-red-600 p-2">Video đã được xử lý và giải phóng khỏi bộ nhớ.</p>`;
                    }
                };
                segmentWrapper.querySelector('.download-btn').onclick = () => {
                    if (codeInfo.blobUrl) {
                        downloadBlob(codeInfo.blobUrl, fileName);
                    } else {
                        alert('Video đã được xử lý và giải phóng khỏi bộ nhớ.');
                    }
                };
                uploadButton.onclick = (e) => uploadVideoToDrive(codeInfo, fileName, cameraMessageAreaEl, e.currentTarget);
                
                cameraSegmentsEl.appendChild(segmentWrapper);
            }

            // --- NEW: Memory Management and Auto-Actions Logic ---
            
            /**
             * Handles all actions needed when a new video segment is finalized.
             */
            function handleNewSegmentCompletion(codeInfo) {
                // 1. Create the UI for the new segment
                createCameraSegmentUI(codeInfo);

                // 2. Perform auto-download if checked
                if (codeInfo.downloadRequired) {
                    const extension = getMimeTypeExtension(codeInfo.blob.type);
                    const fileName = `CAM_CODE_${sanitizeFileName(codeInfo.data)}_${new Date(codeInfo.startTimeMs).toLocaleTimeString().replace(/:/g, '-')}.${extension}`;
                    
                    // Trigger download immediately
                    downloadBlob(codeInfo.blobUrl, fileName);
                    
                    // Mark as downloaded and check if memory can be released
                    codeInfo.isDownloaded = true;
                    checkAndReleaseMemory(codeInfo);
                }

                // 3. Perform auto-upload if checked
                if (codeInfo.uploadRequired) {
                    const extension = getMimeTypeExtension(codeInfo.blob.type);
                    const fileName = `CAM_CODE_${sanitizeFileName(codeInfo.data)}_${new Date(codeInfo.startTimeMs).toLocaleTimeString().replace(/:/g, '-')}.${extension}`;
                    
                    // Call upload without a button element for automatic action
                    uploadVideoToDrive(codeInfo, fileName, cameraMessageAreaEl, null);
                }
                
                // 4. If no auto-actions are required, check for release immediately.
                if (!codeInfo.downloadRequired && !codeInfo.uploadRequired) {
                     checkAndReleaseMemory(codeInfo);
                }
            }

            /**
             * Checks if all required actions for a segment are complete, 
             * and if so, releases its blob from memory.
             */
            function checkAndReleaseMemory(codeInfo) {
                const canRelease = (!codeInfo.downloadRequired || codeInfo.isDownloaded) && 
                                   (!codeInfo.uploadRequired || codeInfo.isUploaded);

                const segmentUI = document.getElementById(codeInfo.id);
                const statusContainer = segmentUI ? segmentUI.querySelector('.status-indicator-container') : null;

                if (canRelease && codeInfo.blob) {
                    // Release the memory
                    URL.revokeObjectURL(codeInfo.blobUrl);
                    codeInfo.blob = null;
                    codeInfo.blobUrl = null;
                    
                    console.log(`Bộ nhớ cho video "${codeInfo.data}" đã được giải phóng.`);
                    
                    // Update UI to reflect the change
                    if (statusContainer) {
                        statusContainer.innerHTML = `<span class="segment-status bg-green-200 text-green-800">Đã lưu & giải phóng</span>`;
                    }
                    const buttons = segmentUI.querySelectorAll('.action-button');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    });

                } else if (statusContainer) {
                    // Update status if still pending
                    let statuses = [];
                    if (codeInfo.downloadRequired && !codeInfo.isDownloaded) statuses.push("Đang tải về");
                    if (codeInfo.uploadRequired && !codeInfo.isUploaded) statuses.push("Đang tải lên");
                    if(statuses.length > 0) {
                        statusContainer.innerHTML = `<span class="segment-status bg-blue-200 text-blue-800">${statuses.join(' & ')}...</span>`;
                    }
                }
            }


            // --- General Utility Functions ---
            function updateMessage(message, type = 'info', areaElement, showLoader = false) { /* ... (no changes) */ }
            function handleVideoError(error, msgArea, ...buttons) { /* ... (no changes) */ }
            function getSupportedMimeType() { /* ... (no changes) */ }
            function getMimeTypeExtension(mimeType) { /* ... (no changes) */ }
            
            async function downloadAllSegments(codes, baseName, msgAreaElement) {
                 if (typeof JSZip === 'undefined') {
                    updateMessage("Lỗi: Thư viện nén file (JSZip) không thể tải.", 'error', msgAreaElement);
                    return;
                }
                const segmentsWithBlobs = codes.filter(c => c.blob && c.blob.size > 0);
                if (segmentsWithBlobs.length === 0) {
                    updateMessage("Không có đoạn video nào (còn trong bộ nhớ) để tải xuống.", 'warning', msgAreaElement);
                    return;
                }

                updateMessage(`Đang nén ${segmentsWithBlobs.length} file video... Vui lòng đợi.`, 'info', msgAreaElement, true);

                const zip = new JSZip();
                segmentsWithBlobs.forEach((code, index) => {
                    const extension = getMimeTypeExtension(code.blob.type);
                    const fileName = `${baseName}_${index + 1}_${sanitizeFileName(code.data)}.${extension}`;
                    zip.file(fileName, code.blob);
                });

                try {
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    downloadBlob(URL.createObjectURL(zipBlob), `${baseName}_videos.zip`);
                    updateMessage("Đã tạo file zip thành công! Quá trình tải xuống sẽ bắt đầu.", 'success', msgAreaElement);
                } catch (err) {
                    console.error("Lỗi khi tạo file zip:", err);
                    updateMessage("Đã xảy ra lỗi khi tạo file zip.", 'error', msgAreaElement);
                }
            }


            function downloadBlob(blobUrl, fileName) {
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            function sanitizeFileName(name) { return name.replace(/[^a-z0-9_.-]/gi, '_').substring(0, 50); }
            function escapeHTML(str) {
                return str.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            function exportToCSV(dataArray, fileName, msgAreaElement) {
                if (dataArray.length === 0) {
                    updateMessage("Không có dữ liệu để xuất.", "info", msgAreaElement); return;
                }
                let csvContent = "\uFEFFSTT,Loại Code,Dữ liệu Code,Thời điểm\r\n";
                dataArray.forEach((code, index) => {
                    const timeDisplay = code.startTimeMs ? new Date(code.startTimeMs).toLocaleTimeString() : code.time.toFixed(2);
                    csvContent += `${index + 1},${code.type},"${code.data.replace(/"/g, '""')}",${timeDisplay}\r\n`;
                });
                downloadBlob(URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })), fileName);
                updateMessage("Đã xuất CSV thành công!", "success", msgAreaElement);
            }
        }; // End of main function
    }());
    </script>
</body>
</html>
