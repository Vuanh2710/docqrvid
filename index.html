<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Xử Lý Video QR Code: Quét File, Camera & Tải Lên Google</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- THƯ VIỆN BẮT BUỘC: jsQR để quét mã QR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- THƯ VIỆN GOOGLE: Tải GAPI và GIS Client để xác thực -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active {
            border-color: theme('colors.indigo.500');
            background-color: theme('colors.indigo.500');
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Cảnh báo bảo mật quan trọng */
        #security-notice {
            display: none; /* Sẽ được hiển thị bằng JS nếu cần */
            padding: 1rem;
            margin-bottom: 1.5rem;
            background-color: #fffbe6;
            color: #92400e;
            border: 1px solid #fde68a;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 flex items-center justify-center">
    <div class="container mx-auto max-w-4xl bg-white p-5 md:p-8 rounded-xl shadow-2xl">
        <header class="mb-6 md:mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800">Trình Xử Lý Video QR Code & Tải Lên Google Sheets</h1>
        </header>
        
        <div id="security-notice">
            <h3 class="font-bold">Lưu ý Quan trọng</h3>
            <p class="text-sm mt-1">
                Để sử dụng camera, trang này phải được chạy trên một máy chủ web (giao thức <strong>https://</strong> hoặc <strong>http://localhost</strong>). Mở trực tiếp từ file (<strong>file://</strong>) sẽ không hoạt động do chính sách bảo mật của trình duyệt.
            </p>
        </div>


        <section class="mb-6 p-4 border border-gray-300 rounded-lg bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Kết nối Google</h2>
            <div id="googleAuthControls">
                <button id="googleSignInButton" class="google-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                    Đăng nhập với Google
                </button>
                <button id="googleSignOutButton" class="google-button bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm hidden">
                    Đăng xuất Google
                </button>
            </div>
            <div id="googleAuthMessageArea" class="mt-2 text-sm text-gray-600 min-h-[20px]">Vui lòng đăng nhập để sử dụng tính năng tải lên Google Sheets.</div>
        </section>

        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button data-tab="fileTab" class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-md text-indigo-600 hover:bg-indigo-50">
                    Quét Video Từ File
                </button>
                <button data-tab="cameraTab" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-md text-gray-500 hover:text-indigo-600 hover:bg-indigo-50">
                    Quét Từ Camera
                </button>
            </nav>
        </div>

        <div>
            <!-- Tab quét từ File -->
            <div id="fileTabContent" class="tab-content active">
                <section class="mb-6">
                    <label for="videoFile" class="block text-sm font-medium text-gray-700 mb-2">Chọn file video của bạn:</label>
                    <input type="file" id="videoFile" accept="video/*" class="input-field">
                </section>
                <section class="mb-6 relative">
                    <video id="videoPlayer" controls playsinline class="w-full rounded-lg shadow-md aspect-video bg-black"></video>
                    <canvas id="scannerCanvas" class="hidden"></canvas>
                </section>
                 <section class="mb-6">
                    <label for="scanFrequency" class="block text-sm font-medium text-gray-700 mb-2">Tần suất quét (file video):</label>
                    <select id="scanFrequency" class="select-field">
                        <option value="0.5" selected>Bình thường (0.5 giây/khung)</option>
                        <option value="1">Chậm (1 giây/khung)</option>
                    </select>
                </section>
                <section class="mb-6 text-center space-y-3 md:space-y-0 md:space-x-3 flex flex-col md:flex-row justify-center">
                    <button id="scanButton" disabled class="action-button primary-button">Bắt đầu quét QR (File)</button>
                    <button id="exportCsvButton" disabled class="action-button success-button">Xuất CSV QR (File)</button>
                    <button id="uploadSheetFileButton" disabled class="action-button google-button bg-green-700 hover:bg-green-800 text-white font-bold py-2.5 px-6 rounded-lg text-sm disabled:bg-gray-400">Tải lên Google Sheets (File)</button>
                </section>
                <div class="mb-4 min-h-[40px]">
                    <div id="messageArea" class="message-box"><p class="text-gray-500">Vui lòng chọn một video để bắt đầu.</p></div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <section class="info-box">
                        <h2 class="info-box-title">QR Codes (File - Duy nhất):</h2>
                        <div id="qrLog" class="info-box-content"><p class="text-gray-500 italic">Chưa có QR code nào được phát hiện.</p></div>
                    </section>
                    <section class="info-box">
                        <h2 class="info-box-title">Các đoạn video (File - Theo QR):</h2>
                        <div id="segments" class="info-box-content"><p class="text-gray-500 italic">Chưa có đoạn video nào được tạo.</p></div>
                    </section>
                </div>
            </div>

            <!-- Tab quét từ Camera -->
            <div id="cameraTabContent" class="tab-content">
                <section class="mb-6 relative">
                    <video id="cameraPlayer" autoplay playsinline muted class="w-full rounded-lg shadow-md aspect-video bg-black"></video>
                    <canvas id="cameraScannerCanvas" class="hidden"></canvas>
                </section>

                <section class="mb-6">
                    <label for="cameraScanFrequency" class="block text-sm font-medium text-gray-700 mb-2">Tần suất quét (camera):</label>
                    <select id="cameraScanFrequency" class="select-field">
                        <option value="500" selected>Bình thường (0.5 giây)</option>
                        <option value="1000">Chậm (1 giây)</option>
                    </select>
                </section>

                <section class="mb-6 text-center space-y-3 md:space-y-0 md:space-x-3 flex flex-col md:flex-row justify-center">
                    <button id="startCameraButton" class="action-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-lg">
                        Bắt đầu Ghi & Quét QR
                    </button>
                    <button id="stopCameraButton" disabled class="action-button danger-button">Dừng Ghi & Quét</button>
                    <button id="exportCameraCsvButton" disabled class="action-button success-button">Xuất CSV QR (Camera)</button>
                    <button id="uploadSheetCameraButton" disabled class="action-button google-button bg-green-700 hover:bg-green-800 text-white font-bold py-2.5 px-6 rounded-lg text-sm disabled:bg-gray-400">
                        Tải lên Google Sheets (Camera)
                    </button>
                </section>

                <div class="mb-4 min-h-[40px]">
                    <div id="cameraMessageArea" class="message-box">
                         <p class="text-gray-500">Nhấn "Bắt đầu Ghi & Quét QR" để sử dụng camera.</p>
                    </div>
                </div>
                
                 <div class="grid md:grid-cols-2 gap-6">
                    <section class="info-box">
                        <h2 class="info-box-title">QR Codes (Camera - Duy nhất):</h2>
                        <div id="cameraQrLog" class="info-box-content"><p class="text-gray-500 italic">Chưa có QR code nào được phát hiện.</p></div>
                    </section>
                    <section class="info-box">
                        <h2 class="info-box-title">Các đoạn video đã ghi (Camera):</h2>
                        <div id="cameraSegments" class="info-box-content"><p class="text-gray-500 italic">Chưa có đoạn video nào được ghi.</p></div>
                    </section>
                </div>
            </div>
        </div>

         <footer class="mt-8 text-center text-xs text-gray-400">
            <p>Ứng dụng sử dụng thư viện jsQR để nhận diện QR code. Chức năng tải lên Google Sheets yêu cầu bạn đăng nhập và cấp quyền.</p>
        </footer>
    </div>

    <script>
        // --- Cấu hình chung và các biến ---
        const commonStyles = { /* ... giữ nguyên ... */ };
        
        // --- Google API Configuration ---
        const CLIENT_ID = 'YOUR_CLIENT_ID'; // <<<< THAY THẾ BẰNG CLIENT ID CỦA BẠN
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        // DOM Elements
        const googleSignInButton = document.getElementById('googleSignInButton');
        const googleSignOutButton = document.getElementById('googleSignOutButton');
        const googleAuthMessageArea = document.getElementById('googleAuthMessageArea');
        const uploadSheetFileButton = document.getElementById('uploadSheetFileButton');
        const uploadSheetCameraButton = document.getElementById('uploadSheetCameraButton');
        const videoFile = document.getElementById('videoFile');
        const videoPlayer = document.getElementById('videoPlayer');
        const scannerCanvas = document.getElementById('scannerCanvas');
        const scanButton = document.getElementById('scanButton');
        const exportCsvButton = document.getElementById('exportCsvButton');
        const qrLog = document.getElementById('qrLog');
        const segmentsDiv = document.getElementById('segments');
        const messageArea = document.getElementById('messageArea');
        const scanFrequencySelect = document.getElementById('scanFrequency');
        const cameraPlayer = document.getElementById('cameraPlayer');
        const cameraScannerCanvas = document.getElementById('cameraScannerCanvas');
        const startCameraButton = document.getElementById('startCameraButton');
        const stopCameraButton = document.getElementById('stopCameraButton');
        const exportCameraCsvButton = document.getElementById('exportCameraCsvButton');
        const cameraQrLog = document.getElementById('cameraQrLog');
        const cameraSegments = document.getElementById('cameraSegments');
        const cameraMessageArea = document.getElementById('cameraMessageArea');
        const cameraScanFrequencySelect = document.getElementById('cameraScanFrequency');
        
        let tokenClient;

        // --- Logic chính khi trang được tải ---
        document.addEventListener('DOMContentLoaded', () => {
            checkSecurityContext();
            applyStyles();
            if (typeof jsQR === 'undefined') {
                console.error("Thư viện jsQR chưa được tải.");
                updateMessage("Lỗi: Thư viện quét QR code không thể tải.", "error", messageArea);
                updateMessage("Lỗi: Thư viện quét QR code không thể tải.", "error", cameraMessageArea);
                return;
            }
            attachEventListeners();
            gapi.load('client', initializeGapiClient);
        });

        function checkSecurityContext() {
            const notice = document.getElementById('security-notice');
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                notice.style.display = 'block';
                startCameraButton.disabled = true;
            }
        }
        
        function applyStyles() { /* giữ nguyên */ }

        function attachEventListeners() {
            document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', () => handleTabSwitch(button)));
            googleSignInButton.addEventListener('click', handleSignIn);
            googleSignOutButton.addEventListener('click', handleSignOut);
            uploadSheetFileButton.addEventListener('click', () => createAndUploadToSheet(detectedFileQRCodes, "File", messageArea));
            uploadSheetCameraButton.addEventListener('click', () => createAndUploadToSheet(detectedCameraQRCodes, "Camera", cameraMessageArea));
            videoFile.addEventListener('change', handleFileSelect);
            scanButton.addEventListener('click', toggleFileScan);
            exportCsvButton.addEventListener('click', () => exportToCSV(detectedFileQRCodes, "danh_sach_qr_file.csv", messageArea));
            scanFrequencySelect.addEventListener('change', (e) => { currentFileScanStepSeconds = parseFloat(e.target.value); });
            videoPlayer.addEventListener('loadedmetadata', handleVideoFileLoaded);
            videoPlayer.addEventListener('error', (e) => handleVideoError(videoPlayer.error, messageArea, scanButton, exportCsvButton));
            startCameraButton.addEventListener('click', startCameraScanAndRecord);
            stopCameraButton.addEventListener('click', stopCameraScanAndRecord);
            exportCameraCsvButton.addEventListener('click', () => exportToCSV(detectedCameraQRCodes, "danh_sach_qr_camera.csv", cameraMessageArea));
        }

        function handleTabSwitch(button) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const targetTab = button.getAttribute('data-tab');
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === targetTab + 'Content') content.classList.add('active');
            });
            if (targetTab !== 'cameraTab' && isCameraRecording) {
                stopCameraScanAndRecord();
            }
        }

        // --- Google API Functions ---
        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: DISCOVERY_DOCS,
            }).catch(e => {
                console.error("Lỗi khởi tạo GAPI client:", e);
                googleAuthMessageArea.textContent = 'Lỗi khởi tạo Google API.';
            });
            
            if (typeof google === 'undefined' || !google.accounts) {
                 googleAuthMessageArea.textContent = 'Lỗi: Không thể tải thư viện Google Sign-In.';
                 return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: gapiTokenCallback,
            });
        }
        
        function gapiTokenCallback(tokenResponse) {
             if (tokenResponse && tokenResponse.access_token) {
                gapi.client.setToken(tokenResponse);
                updateSigninStatus(true);
            } else {
                updateSigninStatus(false);
                googleAuthMessageArea.textContent = 'Đăng nhập Google thất bại.';
            }
        }
        
        function handleSignIn() {
            if (tokenClient) tokenClient.requestAccessToken({prompt: 'consent'});
        }
        
        function handleSignOut() {
            const token = gapi.client.getToken();
            if (token) google.accounts.oauth2.revoke(token.access_token, () => {
                gapi.client.setToken('');
                updateSigninStatus(false);
            });
        }

        function updateSigninStatus(isSignedIn) {
            googleSignInButton.classList.toggle('hidden', isSignedIn);
            googleSignOutButton.classList.toggle('hidden', !isSignedIn);
            googleAuthMessageArea.textContent = isSignedIn ? 'Đã đăng nhập Google thành công!' : 'Vui lòng đăng nhập để sử dụng tính năng Google.';
            uploadSheetFileButton.disabled = !isSignedIn || detectedFileQRCodes.length === 0;
            uploadSheetCameraButton.disabled = !isSignedIn || detectedCameraQRCodes.length === 0;
        }

        // --- Camera Tab Logic ---
        let cameraStream, detectedCameraQRCodes = [], isCameraRecording = false;
        let currentCameraSegmentRecorder, currentCameraSegmentChunks = [], currentCameraQRData = null;
        let currentCameraSegmentStartTimeMs = 0, cameraScanIntervalId = null, cameraScannerCtx;

        async function startCameraScanAndRecord() {
            if (isCameraRecording) return;
            resetCameraStateBeforeStart();

            try {
                const constraints = { video: { facingMode: "environment" }, audio: true };
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                cameraPlayer.srcObject = cameraStream;
                await cameraPlayer.play(); // Ensure the player starts before proceeding

                cameraScannerCanvas.width = cameraPlayer.videoWidth;
                cameraScannerCanvas.height = cameraPlayer.videoHeight;
                cameraScannerCtx = cameraScannerCanvas.getContext('2d', { willReadFrequently: true });
                
                isCameraRecording = true;
                startCameraButton.disabled = true;
                stopCameraButton.disabled = false;
                cameraScanFrequencySelect.disabled = true;
                updateMessage("Camera đã bật. Đang chờ QR code...", "info", cameraMessageArea);
                
                const scanIntervalMs = parseInt(cameraScanFrequencySelect.value);
                cameraScanIntervalId = setInterval(scanFrameFromCamera, scanIntervalMs);

            } catch (err) {
                console.error("Lỗi truy cập camera:", err);
                let message = `Không thể truy cập camera: ${err.message}.`;
                if (err.name === "NotAllowedError") message = "Bạn đã từ chối quyền truy cập camera.";
                else if (err.name === "NotFoundError") message = "Không tìm thấy thiết bị camera nào.";
                updateMessage(message, "error", cameraMessageArea);
            }
        }

        function scanFrameFromCamera() {
            if (!isCameraRecording || cameraPlayer.paused || cameraPlayer.ended) return;
            
            cameraScannerCtx.drawImage(cameraPlayer, 0, 0, cameraScannerCanvas.width, cameraScannerCanvas.height);
            const imageData = cameraScannerCtx.getImageData(0, 0, cameraScannerCanvas.width, cameraScannerCanvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

            if (code && code.data) {
                const qrData = code.data;
                const nowMs = Date.now();

                // Case 1: First QR code
                if (!currentCameraQRData) {
                    currentCameraQRData = qrData;
                    currentCameraSegmentStartTimeMs = nowMs;
                    detectedCameraQRCodes.push({ data: qrData, id: `qr-cam-${nowMs}`, startTimeMs: nowMs, blob: null });
                    displayQrCodeEntry(0, qrData, `qr-cam-${nowMs}`, cameraQrLog, nowMs);
                    updateMessage(`Phát hiện QR: ${escapeHTML(qrData)}. Bắt đầu ghi...`, "success", cameraMessageArea);
                    startNewCameraSegmentRecording();
                } 
                // Case 2: New, different QR code
                else if (qrData !== currentCameraQRData) {
                    if (currentCameraSegmentRecorder && currentCameraSegmentRecorder.state === "recording") {
                        const previousData = currentCameraQRData;
                        const previousStartTime = currentCameraSegmentStartTimeMs;
                        
                        currentCameraSegmentRecorder.onstop = () => {
                            if (currentCameraSegmentChunks.length > 0) {
                                const blob = new Blob(currentCameraSegmentChunks, { type: currentCameraSegmentRecorder.mimeType });
                                const segmentFileName = `CAM_QR_${sanitizeFileName(previousData)}_${new Date(previousStartTime).toLocaleTimeString().replace(/:/g,'-')}.webm`;
                                const qrInfoForSegment = detectedCameraQRCodes.find(qr => qr.data === previousData && qr.startTimeMs === previousStartTime);
                                if (qrInfoForSegment) qrInfoForSegment.blob = blob;
                                createCameraSegmentUI(qrInfoForSegment, previousStartTime, nowMs, blob, segmentFileName, cameraSegments);
                            }
                            currentCameraSegmentChunks = [];
                        };
                        currentCameraSegmentRecorder.stop();
                    }
                    currentCameraQRData = qrData;
                    currentCameraSegmentStartTimeMs = nowMs;
                    const newQrId = `qr-cam-${nowMs}`;
                    detectedCameraQRCodes.push({ data: qrData, id: newQrId, startTimeMs: nowMs, blob: null });
                    displayQrCodeEntry(0, qrData, newQrId, cameraQrLog, nowMs);
                    updateMessage(`Phát hiện QR mới: ${escapeHTML(qrData)}. Bắt đầu ghi đoạn mới...`, "info", cameraMessageArea);
                    startNewCameraSegmentRecording();
                }
            }
        }

        function startNewCameraSegmentRecording() {
            if (!cameraStream) return;
            currentCameraSegmentChunks = [];
            const mimeType = getSupportedMimeType();
            if (!mimeType) {
                updateMessage("Lỗi: Không tìm thấy định dạng video được hỗ trợ để ghi.", "error", cameraMessageArea);
                stopCameraScanAndRecord(); return;
            }
            try {
                currentCameraSegmentRecorder = new MediaRecorder(cameraStream, { mimeType });
                currentCameraSegmentRecorder.ondataavailable = (event) => { if (event.data.size > 0) currentCameraSegmentChunks.push(event.data); };
                currentCameraSegmentRecorder.onerror = (event) => console.error("Lỗi MediaRecorder:", event.error);
                currentCameraSegmentRecorder.start(1000); // Ghi dữ liệu mỗi giây
            } catch (e) {
                console.error("Lỗi khởi tạo MediaRecorder:", e);
                updateMessage(`Lỗi hệ thống khi bắt đầu ghi: ${e.message}`, "error", cameraMessageArea);
            }
        }

        function stopCameraScanAndRecord() {
             if (!isCameraRecording) return;
            
            if (cameraScanIntervalId) clearInterval(cameraScanIntervalId);
            cameraScanIntervalId = null;

            if (currentCameraSegmentRecorder && currentCameraSegmentRecorder.state === "recording") {
                currentCameraSegmentRecorder.onstop = () => {
                    finalizeStopCamera(); // Finalize after the last segment is processed
                };
                currentCameraSegmentRecorder.stop();
            } else {
                finalizeStopCamera();
            }
            
            isCameraRecording = false;
        }

        function finalizeStopCamera() {
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
            cameraPlayer.srcObject = null;
            
            startCameraButton.disabled = false;
            stopCameraButton.disabled = true;
            cameraScanFrequencySelect.disabled = false;

            if (detectedCameraQRCodes.length > 0) {
                exportCameraCsvButton.disabled = false;
                if(gapi.client.getToken()) uploadSheetCameraButton.disabled = false;
                updateMessage("Đã dừng ghi và quét.", "success", cameraMessageArea);
            } else {
                updateMessage("Đã dừng camera.", "info", cameraMessageArea);
            }
            currentCameraQRData = null;
        }

        function resetCameraStateBeforeStart() {
            detectedCameraQRCodes = [];
            cameraQrLog.innerHTML = '<p class="text-gray-500 italic">Chưa có QR code nào được phát hiện.</p>';
            cameraSegments.innerHTML = '<p class="text-gray-500 italic">Chưa có đoạn video nào được ghi.</p>';
            exportCameraCsvButton.disabled = true; 
            uploadSheetCameraButton.disabled = true;
            currentCameraQRData = null;
            updateMessage('Nhấn "Bắt đầu Ghi & Quét QR" để sử dụng camera.', 'info', cameraMessageArea);
        }

        // --- Các hàm và logic còn lại ---
        const fileScannerCtx = scannerCanvas.getContext('2d', { willReadFrequently: true });
        let detectedFileQRCodes = []; let isFileScanning = false; let currentFileVideoDuration = 0;
        let fileVideoLoaded = false; let currentFileScanStepSeconds = 0.5; let fileScanTimeoutId = null;
        function handleVideoFileLoaded() { /* giữ nguyên */ }
        function handleVideoError(errorObj, msgArea, btn1, btn2) { /* giữ nguyên */ }
        function handleFileSelect(event) { /* giữ nguyên */ }
        function resetFileScannerState() { /* giữ nguyên */ }
        function toggleFileScan() { if (isFileScanning) stopFileScan(); else startFullFileScan(); }
        function stopFileScan() { /* giữ nguyên */ }
        async function startFullFileScan() { /* giữ nguyên */ }
        function processVideoFramesRecursive(currentTimeToScan) { /* giữ nguyên */ }
        function finishFileScan() { /* giữ nguyên */ }
        async function generateVideoFileSegments() { /* giữ nguyên */ }
        function recordSegmentToFile(videoElement, startTime, endTime, msgArea, segmentName) { /* giữ nguyên */ }
        function playFileSegment(startTime, endTime) { /* giữ nguyên */ }
        async function createAndUploadToSheet(dataArray, titleSuffix, msgAreaElement) { /* giữ nguyên */ }
        function updateMessage(message, type = 'info', areaElement) { areaElement.innerHTML = `<p>${escapeHTML(message)}</p>`; /* giữ nguyên phần còn lại */ }
        function displayQrCodeEntry(time, data, qrId, logElement, timestampMs = null) { /* giữ nguyên */ }
        
        function createSegmentUI(index, qrInfo, startTime, endTime, parentDiv, playFn, downloadFn) {
            const segmentWrapper = document.createElement('div');
            segmentWrapper.className = 'segment-item p-3 mb-2 bg-green-50 rounded-md shadow-sm';
            playButton = document.createElement('button');
            playButton.onclick = playFn; //...
            downloadButton = document.createElement('button');
            downloadButton.onclick = downloadFn; //...
            segmentWrapper.appendChild(playButton);
            segmentWrapper.appendChild(downloadButton);
            parentDiv.appendChild(segmentWrapper);
        }

        function createCameraSegmentUI(qrInfo, startTimeMs, endTimeMs, blob, fileName, parentDiv) {
            clearDivContentIfPlaceholder(parentDiv, 'Chưa có đoạn video nào được ghi.');
            const segmentWrapper = document.createElement('div');
            segmentWrapper.className = 'segment-item p-3 mb-2 bg-blue-50 rounded-md shadow-sm';
            const blobUrl = URL.createObjectURL(blob);
            
            const title = document.createElement('p');
            title.innerHTML = `Đoạn cho QR: <span class="break-all font-semibold">${escapeHTML(qrInfo.data)}</span>`;
            const timeInfo = document.createElement('p');
            timeInfo.textContent = `Thời gian: ${new Date(startTimeMs).toLocaleTimeString()} - ${new Date(endTimeMs).toLocaleTimeString()}`;
            
            const playButton = document.createElement('button');
            playButton.textContent = 'Phát lại';
            playButton.onclick = () => {
                const tempVideoPlayer = document.createElement('video');
                tempVideoPlayer.src = blobUrl; tempVideoPlayer.controls = true; tempVideoPlayer.autoplay = true;
                const existingPlayer = segmentWrapper.querySelector('video');
                if (existingPlayer) existingPlayer.remove();
                segmentWrapper.appendChild(tempVideoPlayer);
            };

            const downloadButton = document.createElement('button');
            downloadButton.textContent = 'Tải xuống';
            downloadButton.onclick = () => downloadBlob(blobUrl, fileName);

            segmentWrapper.append(title, timeInfo, playButton, downloadButton);
            parentDiv.appendChild(segmentWrapper);
        }

        function getSupportedMimeType() {
            const mimeTypes = ['video/webm; codecs=vp9,opus', 'video/webm; codecs=vp8,opus', 'video/webm'];
            for (const type of mimeTypes) { if (MediaRecorder.isTypeSupported(type)) return type; }
            return null;
        }
        function downloadBlob(blobUrl, fileName) { /* giữ nguyên */ }
        function sanitizeFileName(name) { return name.replace(/[^a-z0-9_.-]/gi, '_').substring(0, 50); }
        function escapeHTML(str) { if (typeof str !== 'string') return ''; const p = document.createElement('p'); p.appendChild(document.createTextNode(str)); return p.innerHTML; }
        function clearDivContent(div, placeholderHtml) { /* giữ nguyên */ }
        function clearDivContentIfPlaceholder(div, placeholderTextToClear) { /* giữ nguyên */ }
        function exportToCSV(dataArray, fileName, msgAreaElement) { /* giữ nguyên */ }
    </script>
</body>
</html>
