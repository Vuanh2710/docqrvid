<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Xử Lý Video QR & Barcode: Ghi, Lưu & Tải Lên</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsQR for QR Code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- JSZip for zipping files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Google Platform Library & Identity Services Client -->
    <script async defer src="https://apis.google.com/js/api.js" onload="onGapiLoad()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGisLoad()"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; /* Fallback background */
        }
        .tab-button.active {
            background-color: white;
            color: #4f46e5; /* theme('colors.indigo.600') */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            text-align: center;
        }
        .btn:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
            transform: translateY(-2px);
        }
        .btn:disabled {
            background-color: #9ca3af; /* theme('colors.gray.400') */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn-primary { background-color: #4f46e5; color: white; } /* indigo-600 */
        .btn-primary:hover { background-color: #4338ca; } /* indigo-700 */
        .btn-danger { background-color: #dc2626; color: white; } /* red-600 */
        .btn-danger:hover { background-color: #b91c1c; } /* red-700 */
        .btn-success { background-color: #16a34a; color: white; } /* green-600 */
        .btn-success:hover { background-color: #15803d; } /* green-700 */
        .btn-special { background-color: #8b5cf6; color: white; } /* purple-600 */
        .btn-special:hover { background-color: #7c3aed; } /* purple-700 */
        
        .detection-popup {
            animation: fadeInOut 2s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: scale(0.7); }
            20%, 80% { opacity: 1; transform: scale(1); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-blue-100 min-h-screen p-4 md:p-8 flex items-center justify-center">
    <div class="container mx-auto max-w-4xl bg-white/80 backdrop-blur-sm p-5 md:p-8 rounded-2xl shadow-2xl border border-gray-200/50">
        <header class="mb-6 md:mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 tracking-tight">Trình Xử Lý Video & Mã Code</h1>
        </header>

        <!-- Google Authentication Section -->
        <section class="mb-8 p-4 bg-white/60 rounded-xl shadow-md">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">Kết nối Google</h2>
            <div id="googleAuthControls" class="flex items-center space-x-4">
                <button id="googleSignInButton" class="btn bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 text-sm">
                    Đăng nhập với Google
                </button>
                <button id="googleSignOutButton" class="btn bg-red-500 hover:bg-red-600 text-white py-2 px-4 text-sm hidden">
                    Đăng xuất Google
                </button>
                 <div id="googleAuthMessageArea" class="text-sm text-gray-700"></div>
            </div>
        </section>

        <!-- Tabs Navigation -->
        <div class="mb-6">
            <nav class="p-1.5 flex space-x-2 bg-gray-200/70 rounded-xl" aria-label="Tabs">
                <button data-tab="fileTab" class="tab-button active flex-1 py-2 px-4 rounded-lg font-medium text-sm transition-all duration-300">
                    Quét Video Từ File
                </button>
                <button data-tab="cameraTab" class="tab-button flex-1 text-gray-600 py-2 px-4 rounded-lg font-medium text-sm transition-all duration-300">
                    Ghi & Quét Từ Camera
                </button>
            </nav>
        </div>

        <div>
            <!-- File Scanning Tab -->
            <div id="fileTabContent" class="tab-content">
                <section class="mb-6">
                    <label for="videoFile" class="block text-sm font-medium text-gray-700 mb-2">Chọn file video của bạn:</label>
                    <input type="file" id="videoFile" accept="video/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </section>

                <section class="mb-6 relative">
                    <video id="videoPlayer" controls playsinline class="w-full rounded-lg shadow-md aspect-video bg-black"></video>
                    <canvas id="scannerCanvas" class="hidden"></canvas>
                    <div id="fileDetectionOverlay" class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none hidden bg-black bg-opacity-30 rounded-lg">
                        <span class="text-red-500 font-bold text-4xl md:text-5xl text-center break-all" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);"></span>
                    </div>
                </section>

                <section class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button id="scanButton" disabled class="btn btn-primary col-span-2 md:col-span-1">Bắt đầu quét</button>
                    <button id="exportCsvButton" disabled class="btn btn-success">Xuất CSV</button>
                    <button id="downloadAllFileSegmentsButton" disabled class="btn btn-special">Tải tất cả</button>
                    <button id="uploadSheetFileButton" disabled class="btn btn-success">Tải lên Sheets</button>
                </section>

                <div class="mb-4 min-h-[40px]">
                    <div id="messageArea" class="message-box">
                         <p class="text-gray-500 text-center">Vui lòng chọn một video để bắt đầu.</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <section class="bg-white/50 p-4 rounded-lg shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 border-b-2 border-gray-200 pb-2">Mã đã phát hiện (File):</h2>
                        <div id="codeLog" class="space-y-2 max-h-60 overflow-y-auto text-sm pr-2">
                            <p class="text-gray-500 italic">Chưa có mã nào được phát hiện.</p>
                        </div>
                    </section>
                    <section class="bg-white/50 p-4 rounded-lg shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 border-b-2 border-gray-200 pb-2">Các đoạn video (File):</h2>
                        <div id="segments" class="space-y-2 max-h-60 overflow-y-auto text-sm pr-2">
                             <p class="text-gray-500 italic">Chưa có đoạn video nào được tạo.</p>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Camera Recording Tab -->
            <div id="cameraTabContent" class="tab-content hidden">
                <section class="mb-6 relative">
                    <video id="cameraPlayer" autoplay playsinline muted class="w-full rounded-lg shadow-md aspect-video bg-black"></video>
                    <canvas id="cameraScannerCanvas" class="hidden"></canvas>
                     <div id="cameraDetectionOverlay" class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none hidden bg-black bg-opacity-30 rounded-lg">
                        <span class="text-red-500 font-bold text-4xl md:text-5xl text-center break-all" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);"></span>
                    </div>
                </section>

                <section class="mb-6 space-y-3">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button id="startCameraButton" class="btn btn-primary">Bắt đầu Ghi</button>
                        <button id="stopCameraButton" disabled class="btn btn-danger">Dừng Ghi</button>
                        <button id="exportCameraCsvButton" disabled class="btn btn-success">Xuất CSV</button>
                        <button id="downloadAllCameraSegmentsButton" disabled class="btn btn-special">Tải tất cả</button>
                    </div>
                     <div class="grid grid-cols-1">
                        <button id="uploadSheetCameraButton" disabled class="btn btn-success">Tải lên Google Sheets</button>
                    </div>
                    <div class="flex items-center justify-center p-3 bg-gray-100 rounded-lg space-x-6">
                        <div class="flex items-center">
                            <input type="checkbox" id="autoDownloadCheckbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="autoDownloadCheckbox" class="ml-2 block text-sm font-medium text-gray-900">Tự động tải về máy</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="autoUploadCheckbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" disabled>
                            <label for="autoUploadCheckbox" class="ml-2 block text-sm font-medium text-gray-900">Tự động tải lên Drive</label>
                        </div>
                    </div>
                </section>

                <div class="mb-4 min-h-[40px]">
                    <div id="cameraMessageArea" class="message-box">
                         <p class="text-gray-500 text-center">Nhấn "Bắt đầu Ghi & Quét Mã" để sử dụng camera.</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <section class="bg-white/50 p-4 rounded-lg shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 border-b-2 border-gray-200 pb-2">Mã đã phát hiện (Camera):</h2>
                        <div id="cameraCodeLog" class="space-y-2 max-h-60 overflow-y-auto text-sm pr-2">
                            <p class="text-gray-500 italic">Chưa có mã nào được phát hiện.</p>
                        </div>
                    </section>
                    <section class="bg-white/50 p-4 rounded-lg shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 border-b-2 border-gray-200 pb-2">Các đoạn video đã ghi (Camera):</h2>
                        <div id="cameraSegments" class="space-y-2 max-h-60 overflow-y-auto text-sm pr-2">
                             <p class="text-gray-500 italic">Chưa có đoạn video nào được ghi.</p>
                        </div>
                    </section>
                </div>
            </div>
        </div>

         <footer class="mt-8 text-center text-xs text-gray-400">
            <p>Ứng dụng sử dụng thư viện jsQR và Barcode Detector API của trình duyệt. Chức năng Google yêu cầu đăng nhập.</p>
        </footer>
    </div>

    <script>
    // --- Google Auth Initialization ---
    let gapiReady = false;
    let gisReady = false;
    
    function onGapiLoad() {
        gapi.load('client', () => {
            gapiReady = true;
            if (window.tryInitializeApp) window.tryInitializeApp();
        });
    }

    function onGisLoad() {
        gisReady = true;
        if (window.tryInitializeApp) window.tryInitializeApp();
    }
    
    // --- App Logic ---
    (function() {
        if (typeof window.APP_INITIALIZED !== 'undefined') {
            return;
        }
        window.APP_INITIALIZED = true;

        const API_KEY = 'AIzaSyD7pU2xCHySsNnfgvIyCw8h25kwwU7dKo4';
        const CLIENT_ID = '31711163070-g0hhnvlhlvh91jij0k50k58o6usijj17.apps.googleusercontent.com';
        const DISCOVERY_DOCS = [
            "https://sheets.googleapis.com/$discovery/rest?version=v4",
            "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"
        ];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        
        let appStarted = false;
        window.tryInitializeApp = function() {
            if (gapiReady && gisReady && !appStarted) {
                appStarted = true;
                main();
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
             if (window.tryInitializeApp) window.tryInitializeApp();
        });


        function main() {
            // DOM Elements
            const googleSignInButton = document.getElementById('googleSignInButton');
            const googleSignOutButton = document.getElementById('googleSignOutButton');
            const googleAuthMessageArea = document.getElementById('googleAuthMessageArea');
            const uploadSheetFileButton = document.getElementById('uploadSheetFileButton');
            const uploadSheetCameraButton = document.getElementById('uploadSheetCameraButton');
            const videoFile = document.getElementById('videoFile');
            const videoPlayer = document.getElementById('videoPlayer');
            const scannerCanvas = document.getElementById('scannerCanvas');
            const scanButton = document.getElementById('scanButton');
            const exportCsvButton = document.getElementById('exportCsvButton');
            const downloadAllFileSegmentsButton = document.getElementById('downloadAllFileSegmentsButton');
            const codeLog = document.getElementById('codeLog');
            const segmentsDiv = document.getElementById('segments');
            const messageArea = document.getElementById('messageArea');
            const cameraPlayerEl = document.getElementById('cameraPlayer');
            const cameraScannerCanvasEl = document.getElementById('cameraScannerCanvas');
            const startCameraButton = document.getElementById('startCameraButton');
            const stopCameraButton = document.getElementById('stopCameraButton');
            const exportCameraCsvButton = document.getElementById('exportCameraCsvButton');
            const downloadAllCameraSegmentsButtonCamera = document.querySelectorAll('#cameraTabContent #downloadAllCameraSegmentsButton')[0];
            const cameraCodeLogEl = document.getElementById('cameraCodeLog');
            const cameraSegmentsEl = document.getElementById('cameraSegments');
            const cameraMessageAreaEl = document.getElementById('cameraMessageArea');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            let barcodeDetector;
            let fileScanTimeoutId = null;
            let notificationTimeout;
            let detectedFileCodes = [];
            let isFileScanning = false;
            let fileScannerCtx;
            let currentFileVideoDuration = 0;
            let fileVideoLoaded = false;
            let cameraStream;
            let detectedCameraCodes = [];
            let isCameraRecording = false;
            let currentCameraSegmentRecorder;
            let currentCameraSegmentChunks = [];
            let currentCameraCodeData = null;
            let currentCameraSegmentStartTimeMs = 0;
            let cameraScanIntervalId = null;
            let cameraScannerCtx;
            
            initializeLibraries();
            setupEventListeners();
        
            async function initializeLibraries() {
                if (typeof jsQR === 'undefined') {
                    updateMessage("Lỗi: Thư viện quét QR code (jsQR) không thể tải.", "error", messageArea);
                    updateMessage("Lỗi: Thư viện quét QR code (jsQR) không thể tải.", "error", cameraMessageAreaEl);
                    return;
                }

                if ('BarcodeDetector' in window) {
                    try {
                        const supportedFormats = await window.BarcodeDetector.getSupportedFormats();
                        if (supportedFormats.length > 0) {
                            barcodeDetector = new window.BarcodeDetector({ formats: supportedFormats });
                        } else { throw new Error("No supported formats found"); }
                    } catch (e) {
                        barcodeDetector = null;
                        updateMessage("Không thể khởi tạo tính năng quét Barcode. Chỉ quét được QR.", "warning", messageArea);
                        updateMessage("Không thể khởi tạo tính năng quét Barcode. Chỉ quét được QR.", "warning", cameraMessageAreaEl);
                    }
                } else {
                    updateMessage("Trình duyệt này không hỗ trợ quét Barcode. Chỉ có thể quét mã QR.", "warning", messageArea);
                    updateMessage("Trình duyệt này không hỗ trợ quét Barcode. Chỉ có thể quét mã QR.", "warning", cameraMessageAreaEl);
                }

                fileScannerCtx = scannerCanvas.getContext('2d', { willReadFrequently: true });
                initializeGapiClient();
            }

            function setupEventListeners() {
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        switchTab(button.getAttribute('data-tab'));
                    });
                });

                googleSignInButton.addEventListener('click', handleSignIn);
                googleSignOutButton.addEventListener('click', handleSignOut);
                uploadSheetFileButton.addEventListener('click', () => createAndUploadToSheet(detectedFileCodes, "File", messageArea));
                uploadSheetCameraButton.addEventListener('click', () => createAndUploadToSheet(detectedCameraCodes, "Camera", cameraMessageAreaEl));
                
                videoFile.addEventListener('change', handleFileSelect);
                scanButton.addEventListener('click', toggleFileScan);
                exportCsvButton.addEventListener('click', () => exportToCSV(detectedFileCodes, "danh_sach_code_file.csv", messageArea));
                downloadAllFileSegmentsButton.addEventListener('click', () => downloadAllSegments(detectedFileCodes, 'FILE', messageArea));
                videoPlayer.addEventListener('loadedmetadata', handleFileMetadataLoaded);
                videoPlayer.addEventListener('error', () => handleVideoError(videoPlayer.error, messageArea, scanButton, exportCsvButton));

                startCameraButton.addEventListener('click', startCameraScanAndRecord);
                stopCameraButton.addEventListener('click', stopCameraScanAndRecord);
                exportCameraCsvButton.addEventListener('click', () => exportToCSV(detectedCameraCodes, "danh_sach_code_camera.csv", cameraMessageAreaEl));
                downloadAllCameraSegmentsButtonCamera.addEventListener('click', () => downloadAllSegments(detectedCameraCodes, 'CAM', cameraMessageAreaEl));
            }
            
            function switchTab(targetTab) {
                 tabButtons.forEach(btn => btn.classList.remove('active'));
                 const activeButton = document.querySelector(`[data-tab="${targetTab}"]`);
                 if (activeButton) {
                    activeButton.classList.add('active');
                 }
                 tabContents.forEach(content => {
                    if (content.id === targetTab + 'Content') {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                 });
                 if (targetTab !== 'cameraTab' && isCameraRecording) {
                     stopCameraScanAndRecord();
                 }
            }
            
            async function initializeGapiClient() {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: DISCOVERY_DOCS,
                    });
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: gapiTokenCallback,
                    });
                } catch (e) {
                    console.error("Error initializing Google API Client:", e);
                    let userMessage = "Lỗi khởi tạo Google API.";
                    if (e.result && e.result.error) {
                        const error = e.result.error;
                        userMessage = `Lỗi Google API: API Key không hợp lệ.`;
                        if (error.details && error.details[0] && error.details[0].reason === 'API_KEY_INVALID') {
                             userMessage += " Vui lòng kiểm tra lại API Key và cấu hình trong Google Cloud Console.";
                        }
                    } else if (e.message) {
                         userMessage = `Lỗi: ${e.message}`;
                    }
                    if(googleAuthMessageArea) googleAuthMessageArea.textContent = userMessage;
                }
            }
            
            function gapiTokenCallback(tokenResponse) {
                if (tokenResponse && tokenResponse.access_token) {
                    gapi.client.setToken(tokenResponse);
                    updateSigninStatus(true);
                } else {
                    updateSigninStatus(false);
                    googleAuthMessageArea.textContent = 'Đăng nhập Google thất bại.';
                }
            }
            
            function handleSignIn() {
                if (tokenClient) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    googleAuthMessageArea.textContent = 'Google Client chưa sẵn sàng, vui lòng thử lại sau giây lát.';
                }
            }

            function handleSignOut() {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken('');
                        updateSigninStatus(false);
                    });
                }
            }

            function updateSigninStatus(isSignedIn) {
                const autoUploadCheckbox = document.getElementById('autoUploadCheckbox');
                if (isSignedIn) {
                    googleSignInButton.classList.add('hidden');
                    googleSignOutButton.classList.remove('hidden');
                    googleAuthMessageArea.textContent = 'Đã đăng nhập thành công!';
                    autoUploadCheckbox.disabled = false;
                } else {
                    googleSignInButton.classList.remove('hidden');
                    googleSignOutButton.classList.add('hidden');
                    googleAuthMessageArea.textContent = '';
                    autoUploadCheckbox.disabled = true;
                    autoUploadCheckbox.checked = false;
                }
                updateAllButtonStates();
            }

            function updateAllButtonStates() {
                const isSignedIn = !!(gapi.client && gapi.client.getToken());
                
                uploadSheetFileButton.disabled = detectedFileCodes.length === 0 || !isSignedIn;
                document.querySelectorAll('#segments .upload-drive-button').forEach(btn => {
                    btn.disabled = !isSignedIn || btn.textContent.includes("Đã tải lên") || btn.textContent.includes("Đang tải");
                });
                
                uploadSheetCameraButton.disabled = detectedCameraCodes.length === 0 || !isSignedIn;
                document.querySelectorAll('#cameraSegments .upload-drive-button').forEach(btn => {
                    btn.disabled = !isSignedIn || btn.textContent.includes("Đã tải lên") || btn.textContent.includes("Đang tải");
                });
            }
            
            async function createAndUploadToSheet(dataArray, titleSuffix, msgAreaElement) {
                if (!gapi.client.getToken()) {
                    updateMessage("Bạn chưa đăng nhập Google.", "error", msgAreaElement); return;
                }
                if (dataArray.length === 0) {
                    updateMessage("Không có dữ liệu để tải lên.", "info", msgAreaElement); return;
                }
                updateMessage("Đang chuẩn bị dữ liệu...", "info", msgAreaElement, true);
                
                const sheetTitle = `Code_Data_${titleSuffix}_${new Date().toISOString().slice(0,10)}`;
                const headerRow = ["STT", "Loại Code", "Dữ liệu Code", "Thời điểm"];
                const rows = dataArray.map((code, index) => [
                    index + 1,
                    code.type,
                    code.data,
                    code.startTimeMs ? new Date(code.startTimeMs).toLocaleTimeString() : code.time.toFixed(2)
                ]);
                
                try {
                    updateMessage(`Đang tạo Google Sheet: ${sheetTitle}...`, "info", msgAreaElement, true);
                    const response = await gapi.client.sheets.spreadsheets.create({ properties: { title: sheetTitle } });
                    const spreadsheetId = response.result.spreadsheetId;
                    
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: spreadsheetId,
                        range: 'Sheet1!A1',
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [headerRow, ...rows] }
                    });
                    updateMessage(`Tải lên Google Sheet thành công! <a href="${response.result.spreadsheetUrl}" target="_blank" class="text-blue-600 hover:underline">Mở Sheet</a>`, "success", msgAreaElement);
                } catch (err) {
                    updateMessage(`Lỗi tải lên Google Sheets: ${err.result?.error.message || err.message}`, "error", msgAreaElement);
                }
            }

            async function uploadVideoToDrive(blob, fileName, msgAreaElement, buttonElement, codeInfo) {
                if (!gapi.client.getToken()) {
                    updateMessage("Bạn chưa đăng nhập Google để tải lên.", "error", msgAreaElement); return;
                }
                 if (!blob) {
                    updateMessage("Không có dữ liệu video để tải lên.", "error", msgAreaElement); return;
                }
                
                buttonElement.disabled = true;
                buttonElement.innerHTML = 'Đang tải... <span class="loader"></span>';

                const metadata = { name: fileName, mimeType: blob.type || 'video/webm' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                try {
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token },
                        body: form
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error?.message || 'Lỗi không xác định');
                    
                    updateMessage(`File "${fileName}" đã tải lên Google Drive!`, "success", msgAreaElement);
                    buttonElement.innerHTML = 'Đã tải lên';
                    buttonElement.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                    buttonElement.classList.add('bg-gray-400', 'cursor-not-allowed');

                    if (codeInfo) {
                       codeInfo.isUploaded = true;
                       checkAndReleaseMemory(codeInfo);
                    }

                } catch (err) {
                    updateMessage(`Lỗi tải lên Google Drive: ${err.message}`, "error", msgAreaElement);
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = 'Thử lại';
                }
            }

            // --- File Tab Logic ---
            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    if (!file.type.startsWith('video/')) {
                        updateMessage('Vui lòng chọn một file video hợp lệ.', 'error', messageArea); return;
                    }
                    videoPlayer.src = URL.createObjectURL(file);
                    videoPlayer.load();
                    resetFileScannerState();
                    updateMessage('Đang tải video...', 'info', messageArea, true);
                }
            }
            
            function handleFileMetadataLoaded() {
                scannerCanvas.width = videoPlayer.videoWidth; 
                scannerCanvas.height = videoPlayer.videoHeight;
                currentFileVideoDuration = videoPlayer.duration;
                scanButton.disabled = false; 
                fileVideoLoaded = true;
                updateMessage('Video đã sẵn sàng. Nhấn "Bắt đầu quét" để tìm mã.', 'info', messageArea);
            }

            function resetFileScannerState() {
                if (isFileScanning) stopFileScan();
                detectedFileCodes = [];
                codeLog.innerHTML = '<p class="text-gray-500 italic">Chưa có mã nào được phát hiện.</p>';
                segmentsDiv.innerHTML = '<p class="text-gray-500 italic">Chưa có đoạn video nào được tạo.</p>';
                scanButton.disabled = true; 
                exportCsvButton.disabled = true;
                downloadAllFileSegmentsButton.disabled = true;
                uploadSheetFileButton.disabled = true;
                fileVideoLoaded = false;
                scanButton.textContent = 'Bắt đầu quét';
            }

            function toggleFileScan() {
                isFileScanning ? stopFileScan() : startFullFileScan();
            }

            function stopFileScan() {
                if (fileScanTimeoutId) clearTimeout(fileScanTimeoutId);
                isFileScanning = false;
                scanButton.textContent = 'Bắt đầu quét';
                scanButton.disabled = false;
                updateMessage('Đã dừng quét file.', 'info', messageArea);
            }

            async function startFullFileScan() {
                if (!fileVideoLoaded) return;
                isFileScanning = true;
                scanButton.textContent = 'Dừng quét (0%)';
                updateMessage('Bắt đầu quét file...', 'info', messageArea, true);
                
                detectedFileCodes = [];
                codeLog.innerHTML = '<p class="text-gray-500 italic">Đang quét...</p>';
                segmentsDiv.innerHTML = '';
                videoPlayer.pause(); 
                videoPlayer.currentTime = 0;
                
                await processVideoFrame(0);
            }
            
            async function processVideoFrame(currentTimeToScan) {
                if (!isFileScanning || currentTimeToScan > currentFileVideoDuration) {
                    finishFileScan(); return;
                }
                videoPlayer.currentTime = currentTimeToScan;

                videoPlayer.onseeked = async () => {
                    if (!isFileScanning) { finishFileScan(); return; }
                    
                    fileScannerCtx.drawImage(videoPlayer, 0, 0, scannerCanvas.width, scannerCanvas.height);
                    const detectedCode = await scanCanvasForCode(scannerCanvas, fileScannerCtx);

                    if (detectedCode) {
                        const lastDetected = detectedFileCodes.length > 0 ? detectedFileCodes[detectedFileCodes.length - 1] : null;
                        if (!lastDetected || lastDetected.data !== detectedCode.data) {
                            detectedFileCodes.push({ 
                                time: videoPlayer.currentTime, 
                                data: detectedCode.data, 
                                type: detectedCode.type,
                                id: 'code-file-' + Date.now(), 
                                blob: null 
                            });
                            displayCodeEntry(videoPlayer.currentTime, detectedCode.data, detectedCode.type, codeLog);
                            showDetectionNotification(detectedCode.data, 'fileDetectionOverlay');
                        }
                    }
                    
                    const progress = (currentTimeToScan / currentFileVideoDuration) * 100;
                    scanButton.textContent = `Dừng quét (${progress.toFixed(0)}%)`;
                    
                    fileScanTimeoutId = setTimeout(() => processVideoFrame(currentTimeToScan + 0.5), 50); // Scan every 0.5s
                };
            }

            function finishFileScan() {
                isFileScanning = false;
                scanButton.textContent = 'Bắt đầu quét';
                if (detectedFileCodes.length > 0) {
                    updateMessage(`Quét xong! Tìm thấy ${detectedFileCodes.length} mã. Đang xử lý video...`, 'success', messageArea, true);
                    generateVideoFileSegments();
                    exportCsvButton.disabled = false;
                    downloadAllFileSegmentsButton.disabled = false;
                    if(gapi.client.getToken()) uploadSheetFileButton.disabled = false;
                } else {
                    updateMessage('Quét xong! Không tìm thấy mã nào.', 'info', messageArea);
                }
            }
            
            async function generateVideoFileSegments() {
                if (detectedFileCodes.length === 0) return;
                
                for (let i = 0; i < detectedFileCodes.length; i++) {
                    const startTime = detectedFileCodes[i].time;
                    const endTime = (i + 1 < detectedFileCodes.length) ? detectedFileCodes[i+1].time : currentFileVideoDuration;
                    
                    const blob = await recordSegmentToFile(startTime, endTime);
                    if (blob) {
                        detectedFileCodes[i].blob = blob;
                        createFileSegmentUI(i, detectedFileCodes[i], startTime, endTime, blob);
                    }
                }
                 updateMessage("Các đoạn video từ file đã sẵn sàng.", "success", messageArea);
            }

            function recordSegmentToFile(startTime, endTime) {
                return new Promise(async (resolve, reject) => {
                     if (!('MediaRecorder' in window) || !videoPlayer.captureStream) {
                        updateMessage("Trình duyệt không hỗ trợ ghi video.", 'error', messageArea);
                        return resolve(null);
                    }
                    
                    const mimeType = getSupportedMimeType();
                    if (!mimeType) {
                        updateMessage("Không tìm thấy định dạng video được hỗ trợ để ghi.", 'error', messageArea);
                        return resolve(null);
                    }
                    
                    const recordedChunks = [];
                    const stream = videoPlayer.captureStream();
                    const mediaRecorder = new MediaRecorder(stream, { mimeType });

                    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                    mediaRecorder.onstop = () => resolve(new Blob(recordedChunks, { type: mediaRecorder.mimeType }));
                    mediaRecorder.onerror = e => {
                        console.error("MediaRecorder error:", e);
                        updateMessage("Lỗi khi ghi video.", 'error', messageArea);
                        resolve(null);
                    };

                    const originalMutedState = videoPlayer.muted; 
                    videoPlayer.muted = true;
                    videoPlayer.currentTime = startTime;
                    
                    try {
                        await videoPlayer.play();
                        mediaRecorder.start();
                        const checkTimeInterval = setInterval(() => {
                            if (videoPlayer.currentTime >= endTime || videoPlayer.paused) {
                                clearInterval(checkTimeInterval);
                                if (mediaRecorder.state === "recording") mediaRecorder.stop();
                                videoPlayer.pause();
                                videoPlayer.muted = originalMutedState;
                            }
                        }, 100);
                    } catch (e) {
                        videoPlayer.muted = originalMutedState;
                        reject(e);
                    }
                });
            }
            
            // --- Camera Tab Logic ---
            async function startCameraScanAndRecord() {
                if (isCameraRecording) return;
                resetCameraStateBeforeStart();
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: true });
                    cameraPlayerEl.srcObject = cameraStream;
                    await cameraPlayerEl.play();
                    
                    cameraScannerCanvasEl.width = cameraPlayerEl.videoWidth;
                    cameraScannerCanvasEl.height = cameraPlayerEl.videoHeight;
                    cameraScannerCtx = cameraScannerCanvasEl.getContext('2d', { willReadFrequently: true });
                    
                    isCameraRecording = true;
                    startCameraButton.disabled = true; 
                    stopCameraButton.disabled = false;
                    updateMessage("Camera đang bật. Đang chờ mã đầu tiên...", "info", cameraMessageAreaEl, true);
                    
                    cameraScanIntervalId = setInterval(scanFrameFromCamera, 500); // Scan every 0.5s
                } catch (err) {
                    updateMessage(`Lỗi camera: ${err.message}.`, "error", cameraMessageAreaEl);
                }
            }
            
            async function scanFrameFromCamera() {
                if (!isCameraRecording) return;
                cameraScannerCtx.drawImage(cameraPlayerEl, 0, 0, cameraScannerCanvasEl.width, cameraScannerCanvasEl.height);
                const detectedCode = await scanCanvasForCode(cameraScannerCanvasEl, cameraScannerCtx);

                if (detectedCode) {
                    const codeData = detectedCode.data;
                    const codeType = detectedCode.type;

                    if (!currentCameraCodeData) { // First code detected
                        startNewRecordingForNewCode(codeData, codeType);
                    } else if (codeData !== currentCameraCodeData) { // New, different code detected
                        const endingCodeInfo = detectedCameraCodes.find(c => c.startTimeMs === currentCameraSegmentStartTimeMs);
                        stopCurrentRecordingAndFinalizeSegment(endingCodeInfo).then(() => {
                             startNewRecordingForNewCode(codeData, codeType);
                        });
                    }
                }
            }
            
            function startNewRecordingForNewCode(codeData, codeType) {
                currentCameraCodeData = codeData;
                currentCameraSegmentStartTimeMs = Date.now();
                
                detectedCameraCodes.push({ 
                    data: codeData, 
                    type: codeType, 
                    startTimeMs: currentCameraSegmentStartTimeMs,
                    id: 'code-cam-' + currentCameraSegmentStartTimeMs,
                    blob: null,
                    isDownloaded: false,
                    isUploaded: false
                });

                displayCodeEntry(null, codeData, codeType, cameraCodeLogEl, currentCameraSegmentStartTimeMs);
                updateMessage(`Phát hiện mã: ${codeData}. Bắt đầu ghi...`, "success", cameraMessageAreaEl, true);
                showDetectionNotification(codeData, 'cameraDetectionOverlay');
                startNewCameraSegmentRecording();
            }

            function startNewCameraSegmentRecording() {
                if (!cameraStream) return;
                
                const mimeType = getSupportedMimeType();
                 if (!mimeType) {
                    updateMessage("Không tìm thấy định dạng video được hỗ trợ để ghi.", 'error', cameraMessageAreaEl);
                    return;
                }

                currentCameraSegmentChunks = [];
                currentCameraSegmentRecorder = new MediaRecorder(cameraStream, { mimeType });
                currentCameraSegmentRecorder.ondataavailable = e => { if (e.data.size > 0) currentCameraSegmentChunks.push(e.data); };
                currentCameraSegmentRecorder.onerror = e => {
                     console.error("MediaRecorder error:", e);
                     updateMessage("Lỗi khi ghi video.", 'error', cameraMessageAreaEl);
                };
                currentCameraSegmentRecorder.start();
            }
            
            function stopCurrentRecordingAndFinalizeSegment(codeInfoToFinalize) {
                return new Promise((resolve) => {
                    if (currentCameraSegmentRecorder?.state === "recording") {
                        currentCameraSegmentRecorder.onstop = () => {
                            const blob = new Blob(currentCameraSegmentChunks, { type: currentCameraSegmentRecorder.mimeType });
                            
                            if (codeInfoToFinalize && blob.size > 0) {
                               codeInfoToFinalize.blob = blob;
                               createCameraSegmentUI(codeInfoToFinalize, blob);
                            }
                            
                            currentCameraSegmentChunks = [];
                            resolve();
                        };
                        currentCameraSegmentRecorder.stop();
                    } else {
                        resolve();
                    }
                });
            }

            function stopCameraScanAndRecord() {
                if (!isCameraRecording) return;
                isCameraRecording = false;
                clearInterval(cameraScanIntervalId);
                
                const finalCodeInfo = detectedCameraCodes.find(c => c.startTimeMs === currentCameraSegmentStartTimeMs);

                stopCurrentRecordingAndFinalizeSegment(finalCodeInfo).then(() => {
                    if (cameraStream) {
                        cameraStream.getTracks().forEach(track => track.stop());
                        cameraStream = null;
                    }
                    cameraPlayerEl.srcObject = null;
                    currentCameraCodeData = null;
                    startCameraButton.disabled = false;
                    stopCameraButton.disabled = true;
                    
                    if (detectedCameraCodes.length > 0) {
                        exportCameraCsvButton.disabled = false;
                        downloadAllCameraSegmentsButtonCamera.disabled = false;
                        if(gapi.client.getToken()) uploadSheetCameraButton.disabled = false;
                        updateMessage("Đã dừng ghi. Các đoạn video đã được lưu.", "success", cameraMessageAreaEl);
                    } else {
                         updateMessage("Đã dừng camera.", "info", cameraMessageAreaEl);
                    }
                });
            }

            function resetCameraStateBeforeStart() {
                if (isCameraRecording) stopCameraScanAndRecord();
                detectedCameraCodes = [];
                cameraCodeLogEl.innerHTML = '<p class="text-gray-500 italic">Chưa có mã nào được phát hiện.</p>';
                cameraSegmentsEl.innerHTML = '<p class="text-gray-500 italic">Chưa có đoạn video nào được ghi.</p>';
                exportCameraCsvButton.disabled = true; 
                downloadAllCameraSegmentsButtonCamera.disabled = true;
                uploadSheetCameraButton.disabled = true;
                currentCameraCodeData = null;
            }

            // --- Scanning & UI Helper Functions ---
            async function scanCanvasForCode(canvas, context) {
                // 1. Try QR Code first (jsQR is reliable for QR)
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert"
                });
                if (qrCode && qrCode.data) {
                    return {
                        data: qrCode.data,
                        type: 'QR_CODE'
                    };
                }

                // 2. If no QR, try the native BarcodeDetector API if it was initialized
                if (barcodeDetector) {
                    try {
                        const barcodes = await barcodeDetector.detect(canvas);
                        if (barcodes.length > 0) {
                            // Return the first detected barcode
                            return {
                                data: barcodes[0].rawValue,
                                type: barcodes[0].format.toUpperCase().replace(/_/g, '-') // e.g. code-128
                            };
                        }
                    } catch (err) {
                        console.error("Lỗi Barcode Detector API:", err);
                        // Disable it if it fails consistently
                        barcodeDetector = null; 
                        updateMessage("Lỗi API quét barcode. Tính năng bị vô hiệu hoá.", "error", messageArea);
                    }
                }

                return null;
            }
            
            function showDetectionNotification(codeData, overlayId) {
                const overlay = document.getElementById(overlayId);
                if (!overlay) return;

                const textElement = overlay.querySelector('span');
                textElement.textContent = codeData;

                overlay.classList.remove('hidden');
                overlay.classList.add('detection-popup'); // Apply animation to the overlay

                clearTimeout(notificationTimeout);
                notificationTimeout = setTimeout(() => {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('detection-popup');
                }, 2000); // Hide after 2 seconds (matching animation duration)
            }

            function displayCodeEntry(time, data, type, logElement, timestampMs = null) {
                logElement.querySelector('p.italic')?.remove();
                const div = document.createElement('div');
                div.className = 'p-2.5 bg-white border border-gray-200 rounded-md shadow-sm mb-2';
                let timeDisplay = timestampMs ? `Thời điểm: ${new Date(timestampMs).toLocaleTimeString()}` : `Tại: ${time.toFixed(2)}s`;
                div.innerHTML = `
                    <p class="font-semibold text-indigo-600 text-xs">${escapeHTML(type)}</p>
                    <p class="text-sm break-all">${escapeHTML(data)}</p>
                    <p class="text-xs text-gray-500">${timeDisplay}</p>`;
                logElement.appendChild(div); 
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            function createFileSegmentUI(index, codeInfo, startTime, endTime, blob) {
                const segmentWrapper = document.createElement('div');
                segmentWrapper.id = `segment-${codeInfo.id}`;
                segmentWrapper.className = 'p-3 mb-2 bg-green-50 rounded-md shadow-sm';
                const extension = getMimeTypeExtension(blob.type);
                const fileName = `FILE_CODE_${sanitizeFileName(codeInfo.data)}_${startTime.toFixed(1)}s.${extension}`;

                segmentWrapper.innerHTML = `
                    <p class="font-semibold text-green-700">Đoạn ${index + 1}: ${escapeHTML(codeInfo.type)}</p>
                    <p class="text-sm break-all">${escapeHTML(codeInfo.data)}</p>
                    <p class="text-xs text-gray-700">Từ: ${startTime.toFixed(2)}s - Đến: ${endTime.toFixed(2)}s</p>
                    <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <button class="play-btn action-button bg-blue-500 hover:bg-blue-600 text-white text-sm py-1">Phát</button>
                        <button class="download-btn action-button bg-yellow-500 hover:bg-yellow-600 text-white text-sm py-1">Tải xuống</button>
                        <button class="upload-drive-button action-button google-button bg-purple-500 hover:bg-purple-600 text-white text-sm py-1" ${!(gapi.client && gapi.client.getToken()) && 'disabled'}>Tải lên Drive</button>
                    </div>
                `;
                
                segmentWrapper.querySelector('.play-btn').onclick = () => {
                     videoPlayer.currentTime = startTime; videoPlayer.play(); 
                };
                segmentWrapper.querySelector('.download-btn').onclick = () => downloadBlob(blob, fileName);
                segmentWrapper.querySelector('.upload-drive-button').onclick = (e) => uploadVideoToDrive(blob, fileName, messageArea, e.currentTarget, codeInfo);
                
                segmentsDiv.appendChild(segmentWrapper);
            }

            function createCameraSegmentUI(codeInfo, blob) {
                cameraSegmentsEl.querySelector('p.italic')?.remove();
                const segmentWrapper = document.createElement('div');
                segmentWrapper.id = `segment-${codeInfo.id}`;
                segmentWrapper.className = 'p-3 mb-2 bg-blue-50 rounded-md shadow-sm';
                const extension = getMimeTypeExtension(blob.type);
                const fileName = `CAM_CODE_${sanitizeFileName(codeInfo.data)}_${new Date(codeInfo.startTimeMs).toLocaleTimeString().replace(/:/g,'-')}.${extension}`;
                
                segmentWrapper.innerHTML = `
                    <p class="font-semibold text-blue-700">${escapeHTML(codeInfo.type)}</p>
                    <p class="text-sm break-all">${escapeHTML(codeInfo.data)}</p>
                    <p class="text-xs text-gray-700">Thời gian: ${new Date(codeInfo.startTimeMs).toLocaleTimeString()}</p>
                    <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <button class="play-btn action-button bg-sky-500 hover:bg-sky-600 text-white text-sm py-1">Phát</button>
                        <button class="download-btn action-button bg-teal-500 hover:bg-teal-600 text-white text-sm py-1">Tải xuống</button>
                        <button class="upload-drive-button action-button google-button bg-purple-500 hover:bg-purple-600 text-white text-sm py-1" ${!(gapi.client && gapi.client.getToken()) && 'disabled'}>Tải lên Drive</button>
                    </div>
                    <div class="video-container mt-2"></div>
                `;
                
                const uploadButton = segmentWrapper.querySelector('.upload-drive-button');
                const downloadButton = segmentWrapper.querySelector('.download-btn');

                segmentWrapper.querySelector('.play-btn').onclick = () => {
                    const container = segmentWrapper.querySelector('.video-container');
                    container.innerHTML = `<video src="${URL.createObjectURL(codeInfo.blob)}" controls autoplay class="w-full rounded-md mt-2"></video>`;
                };
                downloadButton.onclick = (e) => downloadAndFinalize(e.currentTarget, codeInfo, blob, fileName);
                uploadButton.onclick = (e) => uploadAndFinalize(e.currentTarget, codeInfo, blob, fileName);
                
                cameraSegmentsEl.appendChild(segmentWrapper);

                const autoUploadCheckbox = document.getElementById('autoUploadCheckbox');
                const autoDownloadCheckbox = document.getElementById('autoDownloadCheckbox');

                if (autoUploadCheckbox.checked && gapi.client && gapi.client.getToken()) {
                    uploadAndFinalize(uploadButton, codeInfo, blob, fileName);
                }
                if (autoDownloadCheckbox.checked) {
                   downloadAndFinalize(downloadButton, codeInfo, blob, fileName);
                }
            }

            // --- General Utility Functions ---
            function updateMessage(message, type = 'info', areaElement, showLoader = false) {
                areaElement.innerHTML = `<p>${escapeHTML(message)} ${showLoader ? '<span class="loader"></span>' : ''}</p>`;
                areaElement.className = 'p-3 rounded-md text-sm text-center';
                const typeClasses = {
                    error: 'bg-red-100 text-red-700',
                    success: 'bg-green-100 text-green-700',
                    warning: 'bg-yellow-100 text-yellow-700',
                    info: 'bg-blue-100 text-blue-700'
                };
                const classesToAdd = typeClasses[type] || typeClasses.info;
                areaElement.classList.add(...classesToAdd.split(' '));
            }

            function handleVideoError(error, msgArea, ...buttons) {
                updateMessage('Lỗi tải video.', 'error', msgArea);
                buttons.forEach(btn => btn.disabled = true);
            }
            
            function getSupportedMimeType() {
                const types = [
                    'video/mp4; codecs="avc1.42E01E"',
                    'video/mp4',
                    'video/webm; codecs=vp9,opus',
                    'video/webm; codecs=vp8,opus',
                    'video/webm',
                ];
                for (const type of types) {
                    if (MediaRecorder.isTypeSupported(type)) {
                        return type;
                    }
                }
                return null;
            }
            
            function getMimeTypeExtension(mimeType) {
                if (mimeType.includes('mp4')) {
                    return 'mp4';
                }
                return 'webm';
            }
            
            async function downloadAllSegments(codes, baseName, msgAreaElement) {
                if (typeof JSZip === 'undefined') {
                    updateMessage("Lỗi: Thư viện nén file (JSZip) không thể tải.", 'error', msgAreaElement);
                    return;
                }
                const segmentsWithBlobs = codes.filter(c => c.blob && c.blob.size > 0);
                if (segmentsWithBlobs.length === 0) {
                    updateMessage("Không có đoạn video nào để tải xuống.", 'warning', msgAreaElement);
                    return;
                }

                updateMessage(`Đang nén ${segmentsWithBlobs.length} file video... Vui lòng đợi.`, 'info', msgAreaElement, true);

                const zip = new JSZip();
                segmentsWithBlobs.forEach((code, index) => {
                    const extension = getMimeTypeExtension(code.blob.type);
                    const fileName = `${baseName}_${index + 1}_${sanitizeFileName(code.data)}.${extension}`;
                    zip.file(fileName, code.blob);
                });

                try {
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    downloadBlob(zipBlob, `${baseName}_videos.zip`);
                    updateMessage("Đã tạo file zip thành công! Quá trình tải xuống sẽ bắt đầu.", 'success', msgAreaElement);
                } catch (err) {
                    console.error("Lỗi khi tạo file zip:", err);
                    updateMessage("Đã xảy ra lỗi khi tạo file zip.", 'error', msgAreaElement);
                }
            }

            function downloadBlob(blob, fileName) {
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            }

            function sanitizeFileName(name) { return name.replace(/[^a-z0-9_.-]/gi, '_').substring(0, 50); }
            function escapeHTML(str) {
                return str.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            function exportToCSV(dataArray, fileName, msgAreaElement) {
                if (dataArray.length === 0) {
                    updateMessage("Không có dữ liệu để xuất.", "info", msgAreaElement); return;
                }
                let csvContent = "\uFEFFSTT,Loại Code,Dữ liệu Code,Thời điểm\r\n";
                dataArray.forEach((code, index) => {
                    const timeDisplay = code.startTimeMs ? new Date(code.startTimeMs).toLocaleTimeString() : code.time.toFixed(2);
                    csvContent += `${index + 1},${code.type},"${code.data.replace(/"/g, '""')}",${timeDisplay}\r\n`;
                });
                downloadBlob(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }), fileName);
                updateMessage("Đã xuất CSV thành công!", "success", msgAreaElement);
            }
            
            async function downloadAndFinalize(buttonEl, codeInfo, blob, fileName) {
                if (buttonEl.disabled) return;
                
                buttonEl.disabled = true;
                buttonEl.innerHTML = 'Đang tải về...';

                downloadBlob(blob, fileName);

                codeInfo.isDownloaded = true;
                buttonEl.innerHTML = 'Đã tải về';
                buttonEl.classList.remove('bg-teal-500', 'hover:bg-teal-600');
                buttonEl.classList.add('bg-gray-400', 'cursor-not-allowed');
                checkAndReleaseMemory(codeInfo);
            }

            async function uploadAndFinalize(buttonEl, codeInfo, blob, fileName) {
                 if (buttonEl.disabled) return;

                if (!gapi.client.getToken()) {
                    updateMessage("Bạn chưa đăng nhập Google để tải lên.", "error", cameraMessageAreaEl); return;
                }
                 if (!blob) {
                    updateMessage("Không có dữ liệu video để tải lên.", "error", cameraMessageAreaEl); return;
                }
                
                buttonEl.disabled = true;
                buttonEl.innerHTML = 'Đang tải... <span class="loader"></span>';

                const metadata = { name: fileName, mimeType: blob.type };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                try {
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token },
                        body: form
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error?.message || 'Lỗi không xác định');
                    
                    updateMessage(`File "${fileName}" đã tải lên Google Drive!`, "success", cameraMessageAreaEl);
                    buttonEl.innerHTML = 'Đã tải lên';
                    buttonEl.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                    buttonEl.classList.add('bg-gray-400', 'cursor-not-allowed');

                    codeInfo.isUploaded = true;
                    checkAndReleaseMemory(codeInfo);

                } catch (err) {
                    updateMessage(`Lỗi tải lên Google Drive: ${err.message}`, "error", cameraMessageAreaEl);
                    buttonEl.disabled = false;
                    buttonEl.innerHTML = 'Thử lại';
                }
            }

            function checkAndReleaseMemory(codeInfo) {
                const autoDownload = document.getElementById('autoDownloadCheckbox').checked;
                const autoUpload = document.getElementById('autoUploadCheckbox').checked;

                const downloaded = !autoDownload || codeInfo.isDownloaded;
                const uploaded = !autoUpload || codeInfo.isUploaded;

                if (downloaded && uploaded) {
                    const codeIndex = detectedCameraCodes.findIndex(c => c.id === codeInfo.id);
                    if (codeIndex > -1) {
                        URL.revokeObjectURL(cameraSegmentsEl.querySelector(`#segment-${codeInfo.id} .play-btn`)?.src);
                        detectedCameraCodes[codeIndex].blob = null; 
                    }

                    const segmentWrapper = document.getElementById(`segment-${codeInfo.id}`);
                    if (segmentWrapper) {
                        segmentWrapper.querySelector('.play-btn').disabled = true;
                        segmentWrapper.querySelector('.download-btn').disabled = true;
                        segmentWrapper.querySelector('.upload-drive-button').disabled = true;

                        const statusDiv = document.createElement('div');
                        statusDiv.className = 'text-xs text-green-600 italic mt-1 font-semibold';
                        statusDiv.textContent = 'Đã xử lý & giải phóng bộ nhớ.';
                        segmentWrapper.appendChild(statusDiv);
                    }
                }
            }
        } // End of main function
    })();
    </script>
</body>
</html>
