<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Xử Lý Video QR Code: Quét File, Camera & Tải Lên Google</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab-button.active {
            border-color: theme('colors.indigo.500');
            background-color: theme('colors.indigo.500');
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .segment-button:focus, .segment-button:active,
        .download-button:focus, .download-button:active,
        .action-button:focus, .action-button:active,
        .google-button:focus, .google-button:active, /* Style for Google buttons */
        select:focus {
            outline: none;
            box-shadow: 0 0 0 2px theme('colors.indigo.500');
        }
        #messageArea p, #cameraMessageArea p, #googleAuthMessageArea p { word-break: break-word; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #cameraPlayer {
            max-width: 100%;
            height: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 flex items-center justify-center">
    <div class="container mx-auto max-w-4xl bg-white p-5 md:p-8 rounded-xl shadow-2xl">
        <header class="mb-6 md:mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800">Trình Xử Lý Video QR Code & Tích Hợp Google</h1>
        </header>

        <section class="mb-6 p-4 border border-gray-300 rounded-lg bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Kết nối Google</h2>
            <div id="googleAuthControls">
                <button id="googleSignInButton" class="google-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                    Đăng nhập với Google
                </button>
                <button id="googleSignOutButton" class="google-button bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm hidden">
                    Đăng xuất Google
                </button>
            </div>
            <div id="googleAuthMessageArea" class="mt-2 text-sm text-gray-600 min-h-[20px]">Vui lòng đăng nhập để sử dụng tính năng tải lên Google Sheets/Drive.</div>
        </section>

        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button data-tab="fileTab" class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-md text-indigo-600 hover:bg-indigo-50">
                    Quét Video Từ File
                </button>
                <button data-tab="cameraTab" class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-md text-gray-500 hover:text-indigo-600 hover:bg-indigo-50">
                    Quét Từ Camera Trực Tiếp
                </button>
            </nav>
        </div>

        <div>
            <div id="fileTabContent" class="tab-content active">
                <section class="mb-6">
                    <label for="videoFile" class="block text-sm font-medium text-gray-700 mb-2">Chọn file video của bạn:</label>
                    <input type="file" id="videoFile" accept="video/*" class="input-field">
                </section>

                <section class="mb-6 relative">
                    <video id="videoPlayer" controls playsinline class="w-full rounded-lg shadow-md aspect-video bg-black"></video>
                    <canvas id="scannerCanvas" class="hidden"></canvas>
                </section>

                <section class="mb-6">
                    <label for="scanFrequency" class="block text-sm font-medium text-gray-700 mb-2">Tần suất quét (file video):</label>
                    <select id="scanFrequency" class="select-field">
                        <option value="0.1">Rất nhanh (0.1 giây/khung)</option>
                        <option value="0.25">Nhanh (0.25 giây/khung)</option>
                        <option value="0.5" selected>Bình thường (0.5 giây/khung)</option>
                        <option value="0.75">Hơi chậm (0.75 giây/khung)</option>
                        <option value="1">Chậm (1 giây/khung)</option>
                        <option value="1.5">Rất chậm (1.5 giây/khung)</option>
                    </select>
                </section>

                <section class="mb-6 text-center space-y-3 md:space-y-0 md:space-x-3 flex flex-col md:flex-row justify-center">
                    <button id="scanButton" disabled class="action-button primary-button">
                        Bắt đầu quét QR (File)
                    </button>
                    <button id="exportCsvButton" disabled class="action-button success-button">
                        Xuất CSV QR (File)
                    </button>
                    <button id="uploadSheetFileButton" disabled class="action-button google-button bg-green-700 hover:bg-green-800 text-white font-bold py-2.5 px-6 rounded-lg text-sm disabled:bg-gray-400">
                        Tải lên Google Sheets (File)
                    </button>
                </section>

                <div class="mb-4 min-h-[40px]">
                    <div id="messageArea" class="message-box">
                         <p class="text-gray-500">Vui lòng chọn một video để bắt đầu.</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <section class="info-box">
                        <h2 class="info-box-title">QR Codes (File - Duy nhất):</h2>
                        <div id="qrLog" class="info-box-content">
                            <p class="text-gray-500 italic">Chưa có QR code nào được phát hiện.</p>
                        </div>
                    </section>
                    <section class="info-box">
                        <h2 class="info-box-title">Các đoạn video (File - Theo QR):</h2>
                        <div id="segments" class="info-box-content">
                             <p class="text-gray-500 italic">Chưa có đoạn video nào được tạo.</p>
                        </div>
                    </section>
                </div>
            </div>

            <div id="cameraTabContent" class="tab-content">
                <section class="mb-6 relative">
                    <video id="cameraPlayer" autoplay playsinline muted class="w-full rounded-lg shadow-md aspect-video bg-black"></video>
                    <canvas id="cameraScannerCanvas" class="hidden"></canvas>
                </section>

                <section class="mb-6">
                    <label for="cameraScanFrequency" class="block text-sm font-medium text-gray-700 mb-2">Tần suất quét (camera):</label>
                    <select id="cameraScanFrequency" class="select-field">
                        <option value="250">Rất nhanh (0.25 giây)</option>
                        <option value="500" selected>Bình thường (0.5 giây)</option>
                        <option value="750">Hơi chậm (0.75 giây)</option>
                        <option value="1000">Chậm (1 giây)</option>
                    </select>
                </section>

                <section class="mb-6 text-center space-y-3 md:space-y-0 md:space-x-3 flex flex-col md:flex-row justify-center">
                    <button id="startCameraButton" class="action-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-lg">
                        Bắt đầu Ghi & Quét QR
                    </button>
                    <button id="stopCameraButton" disabled class="action-button danger-button">
                        Dừng Ghi & Quét
                    </button>
                    <button id="exportCameraCsvButton" disabled class="action-button success-button">
                        Xuất CSV QR (Camera)
                    </button>
                     <button id="uploadSheetCameraButton" disabled class="action-button google-button bg-green-700 hover:bg-green-800 text-white font-bold py-2.5 px-6 rounded-lg text-sm disabled:bg-gray-400">
                        Tải lên Google Sheets (Camera)
                    </button>
                </section>

                <div class="mb-4 min-h-[40px]">
                    <div id="cameraMessageArea" class="message-box">
                         <p class="text-gray-500">Nhấn "Bắt đầu Ghi & Quét QR" để sử dụng camera.</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <section class="info-box">
                        <h2 class="info-box-title">QR Codes (Camera - Duy nhất):</h2>
                        <div id="cameraQrLog" class="info-box-content">
                            <p class="text-gray-500 italic">Chưa có QR code nào được phát hiện.</p>
                        </div>
                    </section>
                    <section class="info-box">
                        <h2 class="info-box-title">Các đoạn video đã ghi (Camera):</h2>
                        <div id="cameraSegments" class="info-box-content">
                             <p class="text-gray-500 italic">Chưa có đoạn video nào được ghi.</p>
                        </div>
                    </section>
                </div>
            </div>
        </div>

         <footer class="mt-8 text-center text-xs text-gray-400">
            <p>Ứng dụng sử dụng thư viện jsQR để nhận diện QR code. Chức năng tải lên Google yêu cầu bạn đăng nhập và cấp quyền.</p>
        </footer>
    </div>

    <script>
        // Common Tailwind classes for reuse
        const commonStyles = {
            inputField: `block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent`,
            selectField: `block w-full md:w-1/2 text-sm text-gray-700 py-2 px-3 rounded-lg border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent`,
            actionButton: `font-bold py-2.5 px-6 rounded-lg transition-all duration-150 ease-in-out shadow-md hover:shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed`,
            primaryButton: `bg-indigo-600 hover:bg-indigo-700 text-white`,
            dangerButton: `bg-red-600 hover:bg-red-700 text-white`,
            successButton: `bg-green-600 hover:bg-green-700 text-white`,
            messageBox: `p-3 rounded-md text-sm text-center transition-all duration-300 ease-in-out`,
            infoBox: `bg-gray-50 p-4 rounded-lg shadow-md`,
            infoBoxTitle: `text-lg md:text-xl font-semibold text-gray-700 mb-3 border-b pb-2`,
            infoBoxContent: `space-y-2 max-h-60 overflow-y-auto text-sm pr-2`
        };

        function applyStyles() {
            document.getElementById('videoFile').className = commonStyles.inputField;
            document.getElementById('scanFrequency').className = commonStyles.selectField;
            document.getElementById('cameraScanFrequency').className = commonStyles.selectField;
            
            document.getElementById('scanButton').className = `${commonStyles.actionButton} ${commonStyles.primaryButton}`;
            document.getElementById('exportCsvButton').className = `${commonStyles.actionButton} ${commonStyles.successButton}`;
            document.getElementById('uploadSheetFileButton').className = `${commonStyles.actionButton} google-button bg-green-700 hover:bg-green-800 text-white text-sm`;
            
            document.getElementById('startCameraButton').className = `${commonStyles.actionButton} bg-blue-600 hover:bg-blue-700 text-white`;
            document.getElementById('stopCameraButton').className = `${commonStyles.actionButton} ${commonStyles.dangerButton}`;
            document.getElementById('exportCameraCsvButton').className = `${commonStyles.actionButton} ${commonStyles.successButton}`;
            document.getElementById('uploadSheetCameraButton').className = `${commonStyles.actionButton} google-button bg-green-700 hover:bg-green-800 text-white text-sm`;

            document.getElementById('messageArea').className = commonStyles.messageBox;
            document.getElementById('cameraMessageArea').className = commonStyles.messageBox;
            
            document.querySelectorAll('#qrLogContainer, #segmentsContainer, #cameraQrLogContainer, #cameraSegmentsContainer').forEach(el => {
                if(el) el.className = commonStyles.infoBox; // Check if element exists if IDs change
            });
             document.querySelectorAll('#qrLogContainer h2, #segmentsContainer h2, #cameraQrLogContainer h2, #cameraSegmentsContainer h2').forEach(el => {
                if(el) el.className = commonStyles.infoBoxTitle;
            });
            document.querySelectorAll('#qrLog, #segments, #cameraQrLog, #cameraSegments').forEach(el => {
                 if(el) el.className = commonStyles.infoBoxContent;
            });
        }
        document.addEventListener('DOMContentLoaded', applyStyles);


        // --- Google API Configuration ---
        const API_KEY = 'AIzaSyDpkiXjy35byWhE3oRtekt5rJ2Qp-7uW8Y'; // <<<< THAY THẾ BẰNG API KEY CỦA BẠN
        const CLIENT_ID = 'AIzaSyDpkiXjy35byWhE3oRtekt5rJ2Qp-7uW8Y'; // <<<< THAY THẾ BẰNG CLIENT ID CỦA BẠN
        const DISCOVERY_DOCS = [
            "https://sheets.googleapis.com/$discovery/rest?version=v4",
            "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"
        ];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';

        const googleSignInButton = document.getElementById('googleSignInButton');
        const googleSignOutButton = document.getElementById('googleSignOutButton');
        const googleAuthMessageArea = document.getElementById('googleAuthMessageArea');
        const uploadSheetFileButton = document.getElementById('uploadSheetFileButton');
        const uploadSheetCameraButton = document.getElementById('uploadSheetCameraButton');

        let gapiLoaded = false;
        let gisInited = false;
        let tokenClient;


        // DOM Elements - File Tab
        const videoFile = document.getElementById('videoFile');
        const videoPlayer = document.getElementById('videoPlayer');
        const scannerCanvas = document.getElementById('scannerCanvas');
        const scanButton = document.getElementById('scanButton');
        const exportCsvButton = document.getElementById('exportCsvButton');
        const qrLog = document.getElementById('qrLog');
        const segmentsDiv = document.getElementById('segments');
        const messageArea = document.getElementById('messageArea');
        const scanFrequencySelect = document.getElementById('scanFrequency');

        // DOM Elements - Camera Tab (khai báo lại để rõ ràng, dù một số có thể trùng tên)
        const cameraPlayer_el = document.getElementById('cameraPlayer'); // Đổi tên để tránh xung đột nếu dùng chung script scope
        const cameraScannerCanvas_el = document.getElementById('cameraScannerCanvas');
        const startCameraButton = document.getElementById('startCameraButton');
        const stopCameraButton = document.getElementById('stopCameraButton');
        const exportCameraCsvButton = document.getElementById('exportCameraCsvButton');
        const cameraQrLog_el = document.getElementById('cameraQrLog');
        const cameraSegments_el = document.getElementById('cameraSegments');
        const cameraMessageArea_el = document.getElementById('cameraMessageArea');
        const cameraScanFrequencySelect_el = document.getElementById('cameraScanFrequency');


        // Tab switching
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetTab = button.getAttribute('data-tab');
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === targetTab + 'Content') {
                        content.classList.add('active');
                    }
                });
                if (targetTab === 'fileTab' && cameraStream && isCameraRecording) {
                    stopCameraScanAndRecord();
                }
            });
        });

        // --- Google API Functions ---
        function handleAuthLoad() {
            gapi.load('client:oauth2', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS,
                });
                gisInited = true; // GAPI client inited for discovery docs
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: gapiTokenCallback, // defined later
                });
                checkInitialSigninStatus();
            } catch (e) {
                console.error("Lỗi khởi tạo Google API Client:", e);
                googleAuthMessageArea.textContent = `Lỗi khởi tạo Google API: ${e.details || e.message || e.toString()}`;
            }
        }
        
        function checkInitialSigninStatus() {
            // For implicit flow, we don't have a persistent session managed by gapi.auth2
            // We rely on the user clicking "Sign In" each time or managing tokens manually (more complex)
            // For simplicity, we'll assume signed out initially and require explicit sign-in.
            updateSigninStatus(false);
        }


        function gapiTokenCallback(tokenResponse) {
            if (tokenResponse && tokenResponse.access_token) {
                gapi.client.setToken(tokenResponse);
                updateSigninStatus(true);
                googleAuthMessageArea.textContent = 'Đã đăng nhập Google thành công!';
            } else {
                console.error('Không nhận được access token.');
                updateSigninStatus(false);
                googleAuthMessageArea.textContent = 'Đăng nhập Google thất bại. Không nhận được token.';
            }
        }
        
        function handleSignIn() {
            if (!gisInited) {
                googleAuthMessageArea.textContent = 'Google API chưa sẵn sàng, vui lòng đợi...';
                return;
            }
            tokenClient.requestAccessToken({prompt: 'consent'});
        }


        function handleSignOut() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    updateSigninStatus(false);
                    googleAuthMessageArea.textContent = 'Đã đăng xuất. Vui lòng đăng nhập để sử dụng tính năng Google.';
                });
            } else {
                 updateSigninStatus(false); // Already signed out or token not set
            }
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                googleSignInButton.classList.add('hidden');
                googleSignOutButton.classList.remove('hidden');
                uploadSheetFileButton.disabled = detectedFileQRCodes.length === 0;
                uploadSheetCameraButton.disabled = detectedCameraQRCodes.length === 0;
                // Enable drive upload buttons on segments when they are created
            } else {
                googleSignInButton.classList.remove('hidden');
                googleSignOutButton.classList.add('hidden');
                uploadSheetFileButton.disabled = true;
                uploadSheetCameraButton.disabled = true;
                // Disable drive upload buttons
                document.querySelectorAll('.upload-drive-button').forEach(btn => btn.disabled = true);
            }
        }


        async function createAndUploadToSheet(dataArray, titleSuffix, msgAreaElement) {
            if (!gapi.client.getToken() || !gapi.client.getToken().access_token) {
                updateMessage("Bạn chưa đăng nhập Google hoặc phiên đã hết hạn.", "error", msgAreaElement);
                return;
            }
            if (dataArray.length === 0) {
                updateMessage("Không có dữ liệu QR để tải lên.", "info", msgAreaElement);
                return;
            }

            updateMessage("Đang chuẩn bị dữ liệu cho Google Sheets...", "info", msgAreaElement, true);

            const sheetTitle = `QR_Data_${titleSuffix}_${new Date().toISOString().slice(0,10)}`;
            const headerRow = ["STT", "ID QR Code", "Thời điểm (File: giây, Camera: HH:MM:SS)", "Dữ liệu QR"];
            const rows = dataArray.map((qr, index) => {
                const stt = index + 1;
                const qrId = qr.id;
                const timeDisplay = qr.startTimeMs ? new Date(qr.startTimeMs).toLocaleTimeString() : qr.time.toFixed(2);
                return [stt.toString(), qrId, timeDisplay, qr.data];
            });

            const values = [headerRow, ...rows];

            try {
                updateMessage(`Đang tạo Google Sheet mới với tên: ${sheetTitle}...`, "info", msgAreaElement, true);
                const response = await gapi.client.sheets.spreadsheets.create({
                    properties: { title: sheetTitle }
                });
                const spreadsheetId = response.result.spreadsheetId;
                updateMessage(`Đã tạo Sheet ID: ${spreadsheetId}. Đang ghi dữ liệu...`, "info", msgAreaElement, true);

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'Sheet1!A1', // Start from A1 of the first sheet
                    valueInputOption: 'USER_ENTERED',
                    resource: { values: values }
                });
                updateMessage(`Dữ liệu đã được tải lên Google Sheet thành công! <a href="${response.result.spreadsheetUrl}" target="_blank" class="text-blue-600 hover:underline">Mở Sheet</a>`, "success", msgAreaElement);

            } catch (err) {
                console.error("Lỗi tải lên Google Sheets:", err);
                updateMessage(`Lỗi tải lên Google Sheets: ${err.result ? err.result.error.message : err.message}`, "error", msgAreaElement);
            }
        }

        async function uploadVideoToDrive(blob, fileName, msgAreaElement, buttonElement) {
            if (!gapi.client.getToken() || !gapi.client.getToken().access_token) {
                updateMessage("Bạn chưa đăng nhập Google hoặc phiên đã hết hạn.", "error", msgAreaElement);
                return;
            }
            if (!blob) {
                updateMessage("Không có dữ liệu video để tải lên.", "error", msgAreaElement);
                return;
            }

            const originalButtonText = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = 'Đang tải lên... <span class="loader"></span>';
            updateMessage(`Đang tải file "${fileName}" lên Google Drive...`, "info", msgAreaElement, true);

            const metadata = {
                name: fileName,
                mimeType: blob.type || 'video/webm', // Default to webm if type is unknown
                // parents: ['YOUR_FOLDER_ID'] // Optional: Uncomment and set a folder ID
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', blob);

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                    body: form
                });

                const result = await response.json();
                if (response.ok && result.id) {
                    updateMessage(`File "${fileName}" đã tải lên Google Drive thành công! ID: ${result.id}`, "success", msgAreaElement);
                     buttonElement.innerHTML = 'Đã tải lên Drive';
                     buttonElement.classList.add('bg-gray-400', 'cursor-not-allowed');
                     buttonElement.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                } else {
                    throw new Error(result.error ? result.error.message : `Lỗi không xác định (HTTP ${response.status})`);
                }
            } catch (err) {
                console.error("Lỗi tải lên Google Drive:", err);
                updateMessage(`Lỗi tải lên Google Drive: ${err.message}`, "error", msgAreaElement);
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonText;
            }
        }


        // --- File Tab Logic ---
        let detectedFileQRCodes = [];
        let isFileScanning = false;
        let fileScannerCtx;
        let currentFileVideoDuration = 0;
        let fileVideoLoaded = false;
        let currentFileScanStepSeconds = 0.5;
        let fileScanTimeoutId = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Google API client load is now handled by handleAuthLoad() at the end of the script
            fileScannerCtx = scannerCanvas.getContext('2d', { willReadFrequently: true });
            if (typeof jsQR === 'undefined') {
                console.error("Thư viện jsQR chưa được tải.");
                updateMessage("Lỗi: Thư viện quét QR code không thể tải.", "error", messageArea);
                updateMessage("Lỗi: Thư viện quét QR code không thể tải.", "error", cameraMessageArea_el);
                scanButton.disabled = true; exportCsvButton.disabled = true; startCameraButton.disabled = true;
                return;
            }
            currentFileScanStepSeconds = parseFloat(scanFrequencySelect.value);
            // Attach Google Auth event listeners
            googleSignInButton.addEventListener('click', handleSignIn);
            googleSignOutButton.addEventListener('click', handleSignOut);
            uploadSheetFileButton.addEventListener('click', () => createAndUploadToSheet(detectedFileQRCodes, "File", messageArea));
        });

        videoFile.addEventListener('change', handleFileSelect);
        scanButton.addEventListener('click', toggleFileScan);
        exportCsvButton.addEventListener('click', () => exportToCSV(detectedFileQRCodes, "danh_sach_qr_file.csv", messageArea));
        scanFrequencySelect.addEventListener('change', (event) => {
            currentFileScanStepSeconds = parseFloat(event.target.value);
            if (!isFileScanning) {
                 updateMessage(`Đã thay đổi tần suất quét file thành ${currentFileScanStepSeconds} giây/khung.`, 'info', messageArea);
            }
        });

        videoPlayer.addEventListener('loadedmetadata', () => {
            if (videoPlayer.videoWidth > 0 && videoPlayer.videoHeight > 0) {
                scannerCanvas.width = videoPlayer.videoWidth; scannerCanvas.height = videoPlayer.videoHeight;
            } else {
                setTimeout(() => {
                    if (videoPlayer.videoWidth > 0 && videoPlayer.videoHeight > 0) {
                        scannerCanvas.width = videoPlayer.videoWidth; scannerCanvas.height = videoPlayer.videoHeight;
                    } else {
                         updateMessage('Không thể lấy kích thước video file.', 'error', messageArea);
                         scanButton.disabled = true; fileVideoLoaded = false; return;
                    }
                }, 500);
            }
            currentFileVideoDuration = videoPlayer.duration;
            scanButton.disabled = false; fileVideoLoaded = true;
            updateMessage('Video file đã tải. Nhấn "Bắt đầu quét QR (File)" để tìm mã.', 'info', messageArea);
            exportCsvButton.disabled = true;
            uploadSheetFileButton.disabled = true; // Disable until QR codes are found & user is signed in
            if(gapi.client.getToken() && gapi.client.getToken().access_token && detectedFileQRCodes.length > 0) uploadSheetFileButton.disabled = false;

        });

        videoPlayer.addEventListener('error', (e) => {
            handleVideoError(videoPlayer.error, messageArea, scanButton, exportCsvButton);
            fileVideoLoaded = false;
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('video/')) {
                    updateMessage('Định dạng file không hợp lệ. Vui lòng chọn một file video.', 'error', messageArea); return;
                }
                const fileURL = URL.createObjectURL(file);
                videoPlayer.src = fileURL; videoPlayer.load();
                resetFileScannerState();
                updateMessage('Đang tải video file, vui lòng đợi...', 'info', messageArea, true);
            }
        }

        function resetFileScannerState() {
            if (isFileScanning) stopFileScan();
            detectedFileQRCodes = [];
            qrLog.innerHTML = '<p class="text-gray-500 italic">Chưa có QR code nào được phát hiện.</p>';
            segmentsDiv.innerHTML = '<p class="text-gray-500 italic">Chưa có đoạn video nào được tạo.</p>';
            scanButton.disabled = true; exportCsvButton.disabled = true; uploadSheetFileButton.disabled = true;
            fileVideoLoaded = false;
            updateMessage('Vui lòng chọn một video file để bắt đầu.', 'info', messageArea);
            scanButton.textContent = 'Bắt đầu quét QR (File)';
            scanButton.classList.remove('bg-red-600', 'hover:bg-red-700');
            scanButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        }

        function toggleFileScan() {
            if (isFileScanning) stopFileScan();
            else startFullFileScan();
        }

        function stopFileScan() {
            if (fileScanTimeoutId) clearTimeout(fileScanTimeoutId);
            isFileScanning = false;
            scanButton.textContent = 'Bắt đầu quét QR (File)';
            scanButton.classList.remove('bg-red-600', 'hover:bg-red-700');
            scanButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            scanButton.disabled = false; scanFrequencySelect.disabled = false;
            updateMessage('Đã dừng quét file. Bạn có thể bắt đầu lại.', 'info', messageArea);
        }

        async function startFullFileScan() {
            if (!fileVideoLoaded || currentFileVideoDuration <= 0) {
                 updateMessage('Video file chưa sẵn sàng.', 'error', messageArea); return;
            }
            if (scannerCanvas.width === 0 || scannerCanvas.height === 0) {
                updateMessage('Kích thước video file không hợp lệ.', 'error', messageArea); return;
            }
            isFileScanning = true;
            scanButton.textContent = 'Dừng quét File (0%)';
            scanButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            scanButton.classList.add('bg-red-600', 'hover:bg-red-700');
            scanButton.disabled = false; exportCsvButton.disabled = true; uploadSheetFileButton.disabled = true; scanFrequencySelect.disabled = true;
            updateMessage(`Bắt đầu quét QR trong file với tần suất ${currentFileScanStepSeconds} giây/khung...`, 'info', messageArea, true);
            detectedFileQRCodes = [];
            qrLog.innerHTML = '<p class="text-gray-500 italic">Đang quét file...</p>';
            segmentsDiv.innerHTML = '<p class="text-gray-500 italic">Chưa có đoạn video nào được tạo.</p>';
            videoPlayer.pause(); videoPlayer.currentTime = 0;
            await processVideoFramesRecursive(0);
        }

        function processVideoFramesRecursive(currentTimeToScan) {
            if (!isFileScanning || currentTimeToScan > currentFileVideoDuration + currentFileScanStepSeconds) {
                finishFileScan(); return;
            }
            videoPlayer.currentTime = Math.min(currentTimeToScan, currentFileVideoDuration);
            const onSeeked = () => {
                videoPlayer.removeEventListener('seeked', onSeeked);
                videoPlayer.removeEventListener('error', onSeekError);
                if (!isFileScanning) { finishFileScan(); return; }
                try {
                    fileScannerCtx.drawImage(videoPlayer, 0, 0, scannerCanvas.width, scannerCanvas.height);
                    const imageData = fileScannerCtx.getImageData(0, 0, scannerCanvas.width, scannerCanvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                    if (code && code.data) {
                        const qrData = code.data;
                        const lastDetected = detectedFileQRCodes.length > 0 ? detectedFileQRCodes[detectedFileQRCodes.length - 1] : null;
                        if (!lastDetected || lastDetected.data !== qrData) {
                            const qrId = 'qr-file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
                            detectedFileQRCodes.push({ time: videoPlayer.currentTime, data: qrData, id: qrId, blob: null }); // Add blob placeholder
                            displayQrCodeEntry(videoPlayer.currentTime, qrData, qrId, qrLog);
                        }
                    }
                } catch (e) { console.error("Lỗi khi quét canvas file:", e); }
                const progress = Math.min(100, (currentTimeToScan / currentFileVideoDuration) * 100);
                if (isFileScanning) scanButton.textContent = `Dừng quét File (${progress.toFixed(0)}%)`;
                fileScanTimeoutId = setTimeout(() => {
                    processVideoFramesRecursive(currentTimeToScan + currentFileScanStepSeconds);
                }, 50);
            };
            const onSeekError = () => {
                videoPlayer.removeEventListener('seeked', onSeeked);
                videoPlayer.removeEventListener('error', onSeekError);
                updateMessage('Lỗi trong quá trình quét video file (seek error).', 'error', messageArea);
                stopFileScan();
            };
            videoPlayer.addEventListener('seeked', onSeeked, { once: true });
            videoPlayer.addEventListener('error', onSeekError, { once: true });
            if (videoPlayer.readyState >= 2 && videoPlayer.currentTime >= currentFileVideoDuration && currentTimeToScan >= currentFileVideoDuration) {
                 setTimeout(() => onSeeked(), 0);
            }
        }

        function finishFileScan() {
            if (fileScanTimeoutId) clearTimeout(fileScanTimeoutId);
            if (isFileScanning) {
                isFileScanning = false;
                scanButton.textContent = 'Bắt đầu quét QR (File)';
                scanButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                scanButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                scanButton.disabled = false; scanFrequencySelect.disabled = false;
                if (detectedFileQRCodes.length > 0) {
                    updateMessage(`Quét file hoàn tất! Tìm thấy ${detectedFileQRCodes.length} QR code(s) duy nhất.`, 'success', messageArea);
                    generateVideoFileSegments(); // This will now also prepare blobs for upload
                    exportCsvButton.disabled = false;
                    if(gapi.client.getToken() && gapi.client.getToken().access_token) uploadSheetFileButton.disabled = false;
                } else {
                    updateMessage('Quét file hoàn tất! Không tìm thấy QR code nào.', 'info', messageArea);
                    if (qrLog.innerHTML.includes('Đang quét file...')) {
                        qrLog.innerHTML = '<p class="text-gray-500 italic">Không có QR code nào được phát hiện.</p>';
                    }
                    segmentsDiv.innerHTML = '<p class="text-gray-500 italic">Không có đoạn video nào được tạo.</p>';
                    exportCsvButton.disabled = true; uploadSheetFileButton.disabled = true;
                }
            }
        }

        async function generateVideoFileSegments() { // Modified to prepare blobs
            clearDivContent(segmentsDiv, '<p class="text-gray-500 italic">Không có QR code duy nhất để tạo đoạn video.</p>');
            if (detectedFileQRCodes.length === 0) return;

            updateMessage("Đang chuẩn bị các đoạn video từ file...", "info", messageArea, true);
            for (let i = 0; i < detectedFileQRCodes.length; i++) {
                const startTime = detectedFileQRCodes[i].time;
                const endTime = (i + 1 < detectedFileQRCodes.length) ? detectedFileQRCodes[i+1].time : currentFileVideoDuration;
                const segmentId = detectedFileQRCodes[i].id;
                const segmentFileName = `FILE_QR_${sanitizeFileName(detectedFileQRCodes[i].data)}_${startTime.toFixed(1)}s-${endTime.toFixed(1)}s.webm`;

                // Generate blob for this segment
                const blob = await recordSegmentToFile(videoPlayer, startTime, endTime, messageArea, `Đoạn file ${i+1}`);
                detectedFileQRCodes[i].blob = blob; // Store the blob for later upload

                createSegmentUI(i, detectedFileQRCodes[i], startTime, endTime, segmentsDiv,
                    () => playFileSegment(startTime, endTime),
                    (event) => downloadBlob(URL.createObjectURL(blob), segmentFileName), // Download button uses the generated blob
                    (event) => uploadVideoToDrive(blob, segmentFileName, messageArea, event.currentTarget) // Upload to Drive button
                );
            }
            updateMessage("Các đoạn video từ file đã sẵn sàng.", "success", messageArea);
        }
        
        // New helper to record a segment from a video element to a blob
        function recordSegmentToFile(videoElement, startTime, endTime, msgArea, segmentName) {
            return new Promise(async (resolve, reject) => {
                if (!('MediaRecorder' in window) || !videoElement.captureStream) {
                    updateMessage(`Trình duyệt không hỗ trợ ghi lại video (${segmentName}).`, 'error', msgArea);
                    reject(new Error('MediaRecorder not supported'));
                    return;
                }
                updateMessage(`Đang xử lý ${segmentName}...`, 'info', msgArea, true);

                const recordedChunks = [];
                let mediaRecorder;
                try {
                    const stream = videoElement.captureStream({ audio: true, video: true });
                    if (!stream.active) throw new Error("Video stream không hoạt động.");
                    const selectedMimeType = getSupportedMimeType();
                    if (!selectedMimeType) throw new Error('Không tìm thấy định dạng video/audio được hỗ trợ.');
                    mediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType });
                } catch (e) {
                    updateMessage(`Lỗi chuẩn bị ghi ${segmentName}: ${e.message}.`, 'error', msgArea);
                    reject(e); return;
                }

                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    if (recordedChunks.length === 0) {
                        updateMessage(`Không có dữ liệu được ghi cho ${segmentName}.`, 'warning', msgArea);
                        resolve(null); // Resolve with null if no data
                    } else {
                        const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
                        resolve(blob);
                    }
                    videoElement.muted = false; // Restore mute state
                };
                mediaRecorder.onerror = e => {
                    updateMessage(`Lỗi ghi ${segmentName}: ${e.error ? e.error.name : 'Unknown'}.`, 'error', msgArea);
                    videoElement.muted = false; reject(e.error || new Error('MediaRecorder error'));
                };

                const originalMutedState = videoElement.muted; videoElement.muted = true;
                videoElement.currentTime = startTime;
                const playPromise = videoElement.play();

                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        try {
                            mediaRecorder.start();
                            const checkTimeInterval = setInterval(() => {
                                if (videoElement.currentTime >= endTime || videoElement.paused) {
                                    clearInterval(checkTimeInterval);
                                    if (mediaRecorder.state === "recording") mediaRecorder.stop();
                                    // Do not restore mute here, onstop will handle it.
                                }
                            }, 100);
                        } catch (e) { reject(e); videoElement.muted = originalMutedState; }
                    }).catch(error => { reject(error); videoElement.muted = originalMutedState; });
                } else { reject(new Error('Play promise undefined')); videoElement.muted = originalMutedState; }
            });
        }


        function playFileSegment(startTime, endTime) {
            videoPlayer.currentTime = startTime;
            videoPlayer.play().catch(e => console.error("Lỗi phát đoạn video file:", e));
            let fileTimeUpdateHandler;
            const onTimeUpdate = () => {
                if (videoPlayer.currentTime >= endTime) {
                    videoPlayer.pause();
                    videoPlayer.removeEventListener('timeupdate', onTimeUpdate);
                }
            };
            videoPlayer.removeEventListener('timeupdate', fileTimeUpdateHandler);
            fileTimeUpdateHandler = onTimeUpdate;
            videoPlayer.addEventListener('timeupdate', fileTimeUpdateHandler);
        }
        // downloadFileSegment is now handled by createSegmentUI passing downloadBlob with the pre-generated blob.

        // --- Camera Tab Logic ---
        let cameraStream;
        // cameraMediaRecorder is removed as we use currentCameraSegmentRecorder
        // recordedCameraChunks is removed as we use currentCameraSegmentChunks
        let detectedCameraQRCodes = [];
        let isCameraRecording = false;
        let currentCameraSegmentRecorder;
        let currentCameraSegmentChunks = [];
        let currentCameraQRData = null;
        let currentCameraSegmentStartTimeMs = 0;
        let cameraScanIntervalId = null;
        let cameraScannerCtx;

        startCameraButton.addEventListener('click', startCameraScanAndRecord);
        stopCameraButton.addEventListener('click', stopCameraScanAndRecord);
        exportCameraCsvButton.addEventListener('click', () => exportToCSV(detectedCameraQRCodes, "danh_sach_qr_camera.csv", cameraMessageArea_el));
        uploadSheetCameraButton.addEventListener('click', () => createAndUploadToSheet(detectedCameraQRCodes, "Camera", cameraMessageArea_el));


        async function startCameraScanAndRecord() {
            if (isCameraRecording) {
                updateMessage("Camera đang hoạt động.", "warning", cameraMessageArea_el); return;
            }
            resetCameraStateBeforeStart();
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: true });
                cameraPlayer_el.srcObject = cameraStream;
                cameraPlayer_el.onloadedmetadata = () => {
                    cameraScannerCanvas_el.width = cameraPlayer_el.videoWidth;
                    cameraScannerCanvas_el.height = cameraPlayer_el.videoHeight;
                    cameraScannerCtx = cameraScannerCanvas_el.getContext('2d', { willReadFrequently: true });
                    isCameraRecording = true;
                    startCameraButton.disabled = true; stopCameraButton.disabled = false;
                    exportCameraCsvButton.disabled = true; uploadSheetCameraButton.disabled = true;
                    cameraScanFrequencySelect_el.disabled = true;
                    updateMessage("Camera đã bật. Đang chờ QR code đầu tiên để bắt đầu ghi...", "info", cameraMessageArea_el, true);
                    const scanIntervalMs = parseInt(cameraScanFrequencySelect_el.value);
                    cameraScanIntervalId = setInterval(scanFrameFromCamera, scanIntervalMs);
                };
            } catch (err) {
                console.error("Lỗi truy cập camera:", err);
                updateMessage(`Không thể truy cập camera: ${err.message}.`, "error", cameraMessageArea_el);
                isCameraRecording = false;
            }
        }

        function scanFrameFromCamera() {
            if (!isCameraRecording || !cameraStream || !cameraScannerCtx || cameraPlayer_el.paused || cameraPlayer_el.ended) return;
            try {
                cameraScannerCtx.drawImage(cameraPlayer_el, 0, 0, cameraScannerCanvas_el.width, cameraScannerCanvas_el.height);
                const imageData = cameraScannerCtx.getImageData(0, 0, cameraScannerCanvas_el.width, cameraScannerCanvas_el.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code && code.data) {
                    const qrData = code.data; const nowMs = Date.now();
                    if (!currentCameraQRData) { // QR đầu tiên
                        currentCameraQRData = qrData; currentCameraSegmentStartTimeMs = nowMs;
                        const qrId = 'qr-cam-' + nowMs;
                        detectedCameraQRCodes.push({ time: 0, data: qrData, id: qrId, startTimeMs: nowMs, blob: null });
                        displayQrCodeEntry(0, qrData, qrId, cameraQrLog_el, nowMs);
                        updateMessage(`Phát hiện QR: ${escapeHTML(qrData)}. Bắt đầu ghi đoạn 1...`, "success", cameraMessageArea_el, true);
                        startNewCameraSegmentRecording(qrData);
                    } else if (qrData !== currentCameraQRData) { // QR mới
                        const previousQRData = currentCameraQRData;
                        const previousSegmentStartTimeMs = currentCameraSegmentStartTimeMs;
                        updateMessage(`Phát hiện QR mới: ${escapeHTML(qrData)}. Hoàn tất đoạn cho "${escapeHTML(previousQRData)}".`, "info", cameraMessageArea_el, true);

                        if (currentCameraSegmentRecorder && currentCameraSegmentRecorder.state === "recording") {
                            currentCameraSegmentRecorder.onstop = () => {
                                const blob = new Blob(currentCameraSegmentChunks, { type: currentCameraSegmentRecorder.mimeType });
                                const segmentFileName = `CAM_QR_${sanitizeFileName(previousQRData)}_${new Date(previousSegmentStartTimeMs).toLocaleTimeString().replace(/:/g,'-')}.webm`;
                                const qrInfoForSegment = detectedCameraQRCodes.find(qr => qr.data === previousQRData && qr.startTimeMs === previousSegmentStartTimeMs);
                                if(qrInfoForSegment) qrInfoForSegment.blob = blob; // Store blob

                                createCameraSegmentUI(
                                    qrInfoForSegment ? qrInfoForSegment.id : 'unknown-id', previousQRData,
                                    previousSegmentStartTimeMs, nowMs, blob, segmentFileName, cameraSegments_el
                                );
                                currentCameraSegmentChunks = [];
                                startNewRecordingForNewQR(qrData, nowMs);
                            };
                            currentCameraSegmentRecorder.stop();
                        } else { startNewRecordingForNewQR(qrData, nowMs); }
                    }
                }
            } catch (e) { console.error("Lỗi khi quét frame camera:", e); }
        }
        
        function startNewRecordingForNewQR(qrData, nowMs) {
            currentCameraQRData = qrData; currentCameraSegmentStartTimeMs = nowMs;
            const newQrId = 'qr-cam-' + nowMs;
            const relativeTimeS = detectedCameraQRCodes.length > 0 ? (nowMs - detectedCameraQRCodes[0].startTimeMs) / 1000 : 0;
            detectedCameraQRCodes.push({ time: relativeTimeS, data: qrData, id: newQrId, startTimeMs: nowMs, blob: null });
            displayQrCodeEntry(relativeTimeS, qrData, newQrId, cameraQrLog_el, nowMs);
            updateMessage(`Bắt đầu ghi đoạn cho QR: "${escapeHTML(qrData)}"...`, "info", cameraMessageArea_el, true);
            startNewCameraSegmentRecording(qrData);
        }


        function startNewCameraSegmentRecording(qrDataForSegmentName) {
            if (!cameraStream) return;
            currentCameraSegmentChunks = [];
            const mimeType = getSupportedMimeType();
            if (!mimeType) {
                updateMessage("Không tìm thấy định dạng video/audio được hỗ trợ để ghi từ camera.", "error", cameraMessageArea_el);
                stopCameraScanAndRecord(); return;
            }
            try {
                currentCameraSegmentRecorder = new MediaRecorder(cameraStream, { mimeType });
                currentCameraSegmentRecorder.ondataavailable = (event) => { if (event.data.size > 0) currentCameraSegmentChunks.push(event.data); };
                currentCameraSegmentRecorder.onerror = (event) => {
                    console.error("Lỗi MediaRecorder (camera segment):", event.error);
                    updateMessage(`Lỗi khi ghi đoạn camera: ${event.error.name}`, "error", cameraMessageArea_el);
                };
                currentCameraSegmentRecorder.start();
            } catch (e) {
                console.error("Lỗi khởi tạo MediaRecorder cho đoạn camera:", e);
                updateMessage(`Lỗi hệ thống khi bắt đầu ghi đoạn: ${e.message}`, "error", cameraMessageArea_el);
            }
        }

        function stopCameraScanAndRecord() {
            if (!isCameraRecording) return;
            isCameraRecording = false;
            if (cameraScanIntervalId) clearInterval(cameraScanIntervalId); cameraScanIntervalId = null;
            const nowMs = Date.now();

            if (currentCameraSegmentRecorder && currentCameraSegmentRecorder.state === "recording") {
                currentCameraSegmentRecorder.onstop = () => {
                    if (currentCameraSegmentChunks.length > 0 && currentCameraQRData) {
                        const blob = new Blob(currentCameraSegmentChunks, { type: currentCameraSegmentRecorder.mimeType });
                        const segmentFileName = `CAM_QR_${sanitizeFileName(currentCameraQRData)}_${new Date(currentCameraSegmentStartTimeMs).toLocaleTimeString().replace(/:/g,'-')}_END.webm`;
                        const qrInfoForSegment = detectedCameraQRCodes.find(qr => qr.data === currentCameraQRData && qr.startTimeMs === currentCameraSegmentStartTimeMs);
                         if(qrInfoForSegment) qrInfoForSegment.blob = blob; // Store blob for the last segment

                        createCameraSegmentUI(
                            qrInfoForSegment ? qrInfoForSegment.id : 'unknown-final-id', currentCameraQRData,
                            currentCameraSegmentStartTimeMs, nowMs, blob, segmentFileName, cameraSegments_el
                        );
                    }
                    finalizeStopCamera();
                };
                currentCameraSegmentRecorder.stop();
            } else { finalizeStopCamera(); }

            startCameraButton.disabled = false; stopCameraButton.disabled = true;
            cameraScanFrequencySelect_el.disabled = false;
            if (detectedCameraQRCodes.length > 0) {
                exportCameraCsvButton.disabled = false;
                if(gapi.client.getToken() && gapi.client.getToken().access_token) uploadSheetCameraButton.disabled = false;
                updateMessage("Đã dừng ghi và quét từ camera. Các đoạn đã được lưu.", "success", cameraMessageArea_el);
            } else {
                updateMessage("Đã dừng camera. Không có QR code nào được ghi nhận.", "info", cameraMessageArea_el);
            }
            currentCameraQRData = null;
        }

        function finalizeStopCamera() {
            currentCameraSegmentChunks = [];
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraPlayer_el.srcObject = null;
        }


        function resetCameraStateBeforeStart() {
            if (isCameraRecording) stopCameraScanAndRecord();
            detectedCameraQRCodes = [];
            cameraQrLog_el.innerHTML = '<p class="text-gray-500 italic">Chưa có QR code nào được phát hiện.</p>';
            cameraSegments_el.innerHTML = '<p class="text-gray-500 italic">Chưa có đoạn video nào được ghi.</p>';
            exportCameraCsvButton.disabled = true; uploadSheetCameraButton.disabled = true;
            currentCameraQRData = null; currentCameraSegmentStartTimeMs = 0;
            updateMessage('Nhấn "Bắt đầu Ghi & Quét QR" để sử dụng camera.', 'info', cameraMessageArea_el);
        }


        // --- Helper & Common Functions ---
        function updateMessage(message, type = 'info', areaElement, showLoader = false) {
            let loaderHTML = showLoader ? '<span class="loader"></span>' : '';
            areaElement.innerHTML = `<p>${escapeHTML(message)} ${loaderHTML}</p>`;
            areaElement.className = 'p-3 rounded-md text-sm text-center transition-all duration-300 ease-in-out'; // Reset
            if (type === 'error') areaElement.classList.add('bg-red-100', 'text-red-700');
            else if (type === 'success') areaElement.classList.add('bg-green-100', 'text-green-700');
            else if (type === 'warning') areaElement.classList.add('bg-yellow-100', 'text-yellow-700');
            else areaElement.classList.add('bg-blue-100', 'text-blue-700');
        }

        function handleVideoError(errorObj, msgArea, btn1, btn2) {
            let errorMsg = 'Lỗi khi tải video.';
            if (errorObj) {
                switch (errorObj.code) {
                    case errorObj.MEDIA_ERR_ABORTED: errorMsg = 'Tải video bị hủy.'; break;
                    case errorObj.MEDIA_ERR_NETWORK: errorMsg = 'Lỗi mạng khi tải video.'; break;
                    case errorObj.MEDIA_ERR_DECODE: errorMsg = 'Lỗi giải mã video.'; break;
                    case errorObj.MEDIA_ERR_SRC_NOT_SUPPORTED: errorMsg = 'Nguồn video không được hỗ trợ.'; break;
                    default: errorMsg = 'Lỗi video không xác định.';
                }
            }
            updateMessage(errorMsg, 'error', msgArea);
            if (btn1) btn1.disabled = true; if (btn2) btn2.disabled = true;
        }

        function displayQrCodeEntry(time, data, qrId, logElement, timestampMs = null) {
            const placeholder = logElement.querySelector('p.text-gray-500.italic');
            if (placeholder && (placeholder.textContent.includes('Chưa có QR code') || placeholder.textContent.includes('Đang quét'))) {
                 placeholder.remove();
            }
            const div = document.createElement('div');
            div.className = 'p-2.5 bg-white border border-gray-200 rounded-md shadow-sm';
            let timeDisplay = timestampMs ? `Thời điểm: ${new Date(timestampMs).toLocaleTimeString()}` : `Xuất hiện (file): ${time.toFixed(2)}s`;
            div.innerHTML = `
                <p class="font-semibold text-indigo-600 text-xs">ID: ${escapeHTML(qrId)}</p>
                <p class="text-xs text-gray-600">${timeDisplay}</p>
                <p class="text-xs text-gray-600">Dữ liệu: <span class="font-medium break-all">${escapeHTML(data)}</span></p>`;
            logElement.appendChild(div); logElement.scrollTop = logElement.scrollHeight;
        }

        // Modified to include Upload to Drive button
        function createSegmentUI(index, qrInfo, startTime, endTime, parentDiv, playFn, downloadFn, uploadDriveFn) {
            const segmentWrapper = document.createElement('div');
            segmentWrapper.className = 'segment-item p-3 mb-2 bg-green-50 rounded-md shadow-sm';
            segmentWrapper.setAttribute('data-segment-id', qrInfo.id);

            const playButton = document.createElement('button');
            playButton.className = 'segment-button w-full text-left hover:bg-green-100 p-2 rounded-md transition-all';
            playButton.innerHTML = `
                <span class="font-semibold text-green-700">Đoạn ${index + 1}</span>
                <span class="text-xs text-green-600">(QR: ${escapeHTML(qrInfo.data.substring(0,20))}${qrInfo.data.length > 20 ? '...' : ''})</span><br>
                <span class="text-xs text-gray-700">Từ: ${startTime.toFixed(2)}s - Đến: ${endTime.toFixed(2)}s</span>`;
            playButton.onclick = playFn;

            const downloadButton = document.createElement('button');
            downloadButton.className = 'download-button mt-2 w-full text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-1.5 px-3 rounded-md flex items-center justify-center';
            downloadButton.innerHTML = `Tải xuống đoạn ${index + 1}`;
            downloadButton.onclick = downloadFn;

            const uploadDriveButton = document.createElement('button');
            uploadDriveButton.className = 'upload-drive-button action-button google-button bg-purple-500 hover:bg-purple-600 text-white mt-2 w-full text-sm py-1.5 px-3 rounded-md flex items-center justify-center';
            uploadDriveButton.innerHTML = `Tải lên Drive (Đoạn ${index + 1})`;
            uploadDriveButton.disabled = !(gapi.client.getToken() && gapi.client.getToken().access_token); // Disable if not signed in
            uploadDriveButton.onclick = uploadDriveFn;


            segmentWrapper.appendChild(playButton);
            segmentWrapper.appendChild(downloadButton);
            segmentWrapper.appendChild(uploadDriveButton);
            parentDiv.appendChild(segmentWrapper);
            parentDiv.scrollTop = parentDiv.scrollHeight;
        }


        function createCameraSegmentUI(segmentId, qrData, startTimeMs, endTimeMs, blob, fileName, parentDiv) {
            clearDivContentIfPlaceholder(parentDiv, '<p class="text-gray-500 italic">Chưa có đoạn video nào được ghi.</p>');
            const segmentWrapper = document.createElement('div');
            segmentWrapper.className = 'segment-item p-3 mb-2 bg-blue-50 rounded-md shadow-sm';
            segmentWrapper.setAttribute('data-segment-id', segmentId);
            const blobUrl = URL.createObjectURL(blob);

            const title = document.createElement('p');
            title.className = 'font-semibold text-blue-700';
            title.innerHTML = `Đoạn cho QR: <span class="break-all">${escapeHTML(qrData)}</span>`;

            const timeInfo = document.createElement('p');
            timeInfo.className = 'text-xs text-gray-700';
            timeInfo.textContent = `Thời gian: ${new Date(startTimeMs).toLocaleTimeString()} - ${new Date(endTimeMs).toLocaleTimeString()}`;

            const playButton = document.createElement('button');
            playButton.className = 'segment-button mt-2 w-full text-sm bg-sky-500 hover:bg-sky-600 text-white font-semibold py-1.5 px-3 rounded-md';
            playButton.textContent = 'Phát đoạn đã ghi';
            playButton.onclick = () => { /* ... play logic ... */ 
                const tempVideoPlayer = document.createElement('video');
                tempVideoPlayer.src = blobUrl; tempVideoPlayer.controls = true; tempVideoPlayer.autoplay = true;
                tempVideoPlayer.style.width = "100%"; tempVideoPlayer.style.marginTop = "10px";
                const existingPlayer = segmentWrapper.querySelector('video');
                if (existingPlayer) existingPlayer.remove();
                segmentWrapper.appendChild(tempVideoPlayer);
                // tempVideoPlayer.onended = () => URL.revokeObjectURL(blobUrl); // Don't revoke if download/upload is pending
            };

            const downloadButton = document.createElement('button');
            downloadButton.className = 'download-button mt-2 w-full text-sm bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1.5 px-3 rounded-md';
            downloadButton.textContent = 'Tải xuống đoạn này';
            downloadButton.onclick = () => downloadBlob(blobUrl, fileName);

            const uploadDriveButton = document.createElement('button');
            uploadDriveButton.className = 'upload-drive-button action-button google-button bg-purple-500 hover:bg-purple-600 text-white mt-2 w-full text-sm py-1.5 px-3 rounded-md flex items-center justify-center';
            uploadDriveButton.innerHTML = `Tải lên Drive`;
            uploadDriveButton.disabled = !(gapi.client.getToken() && gapi.client.getToken().access_token);
            uploadDriveButton.onclick = (event) => uploadVideoToDrive(blob, fileName, cameraMessageArea_el, event.currentTarget);


            segmentWrapper.appendChild(title); segmentWrapper.appendChild(timeInfo);
            segmentWrapper.appendChild(playButton); segmentWrapper.appendChild(downloadButton);
            segmentWrapper.appendChild(uploadDriveButton);
            parentDiv.appendChild(segmentWrapper); parentDiv.scrollTop = parentDiv.scrollHeight;
        }

        function getSupportedMimeType() {
            const mimeTypes = [
                'video/webm; codecs=vp9,opus', 'video/webm; codecs=vp8,opus',
                'video/mp4; codecs=avc1.42E01E,mp4a.40.2', 'video/webm', 'video/mp4' ];
            for (const type of mimeTypes) { if (MediaRecorder.isTypeSupported(type)) return type; }
            return null;
        }

        function downloadBlob(blobUrl, fileName) {
            const a = document.createElement('a');
            document.body.appendChild(a);
            a.style.display = 'none'; a.href = blobUrl; a.download = fileName;
            a.click(); document.body.removeChild(a);
            // Consider revoking blobUrl if it's truly a one-time use for download and not play
        }

        function sanitizeFileName(name) { return name.replace(/[^a-z0-9_.-]/gi, '_').substring(0, 50); }
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            const p = document.createElement('p');
            p.appendChild(document.createTextNode(str)); return p.innerHTML;
        }
        function clearDivContent(div, placeholderHtml) { div.innerHTML = placeholderHtml; }
        function clearDivContentIfPlaceholder(div, placeholderTextToClear) {
            const placeholder = div.querySelector('p.text-gray-500.italic');
            if (placeholder && placeholder.textContent.includes(placeholderTextToClear.replace(/<[^>]*>/g, ''))) {
                 placeholder.remove();
            }
        }

        function exportToCSV(dataArray, fileName, msgAreaElement) {
            if (dataArray.length === 0) {
                updateMessage("Không có dữ liệu QR code để xuất.", "info", msgAreaElement); return;
            }
            let csvContent = "\uFEFFSTT,ID QR Code,Thời điểm (File: giây, Camera: HH:MM:SS),Dữ liệu QR\r\n";
            dataArray.forEach((qr, index) => {
                const stt = index + 1; const qrId = qr.id;
                const timeDisplay = qr.startTimeMs ? new Date(qr.startTimeMs).toLocaleTimeString() : qr.time.toFixed(2);
                const qrDataEscaped = `"${qr.data.replace(/"/g, '""')}"`;
                csvContent += `${stt},${qrId},${timeDisplay},${qrDataEscaped}\r\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            downloadBlob(URL.createObjectURL(blob), fileName); // Revoke is handled by downloadBlob if needed
            updateMessage("Đã xuất CSV thành công!", "success", msgAreaElement);
        }

        function handleMediaRecorderStartError(e, buttonEl, originalText, mutedState, msgArea, context) { /* ... */ }
        function handlePlayToRecordError(error, buttonEl, originalText, mutedState, msgArea, context) { /* ... */ }

        // Load Google API client and init
        // This needs to be called after the main script body to ensure all DOM elements are available
        // if they are referenced in the auth functions immediately.
        // However, gapi.load itself is fine here.
        gapi.load('client', handleAuthLoad); // Load 'client' first for gapi.client.init
                                            // then 'oauth2' will be loaded by handleAuthLoad for tokenClient

    </script>
</body>
</html>
